"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("isomorphic-unfetch"),E=require("form-data"),o=require("xstate"),T=t=>{try{return btoa(t),t}catch{return encodeURIComponent(t)}},O=async(t,e,{accessToken:r,name:s,fileId:a,bucketId:i,adminSecret:n,onUploadProgress:l}={})=>{const c={};a&&(c["x-nhost-file-id"]=a),i&&(c["x-nhost-bucket-id"]=i),s&&(c["x-nhost-file-name"]=T(s)),n&&(c["x-hasura-admin-secret"]=n),r&&(c.Authorization=`Bearer ${r}`);const p=`${t}/files`;if(typeof XMLHttpRequest=="undefined")try{const u=await m(p,{method:"POST",headers:c,body:e});return u.ok?{fileMetadata:await u.json(),error:null}:{error:{status:u.status,message:await u.text(),error:u.statusText},fileMetadata:null}}catch(u){return{error:{status:0,message:u.message,error:u.message},fileMetadata:null}}return new Promise(u=>{let d=new XMLHttpRequest;d.responseType="json",d.onload=()=>d.status<200&&d.status>=300?u({fileMetadata:null,error:{error:d.statusText,message:d.statusText,status:d.status}}):u({fileMetadata:d.response,error:null}),d.onerror=()=>u({fileMetadata:null,error:{error:d.statusText,message:d.statusText,status:d.status}}),l&&d.upload.addEventListener("progress",l,!1),d.open("POST",p,!0),Object.entries(c).forEach(([P,D])=>{d.setRequestHeader(P,D)}),d.send(e)})};class U{constructor({url:e}){this.url=e}async upload(e){const{formData:r}=e;return O(this.url,r,{accessToken:this.accessToken,adminSecret:this.adminSecret,bucketId:e.bucketId,fileId:e.id,name:e.name})}async getPresignedUrl(e){try{const{fileId:r}=e,s=await m(`${this.url}/files/${r}/presignedurl`,{method:"GET",headers:this.generateAuthHeaders()});if(!s.ok)throw new Error(await s.text());return{presignedUrl:await s.json(),error:null}}catch(r){return{presignedUrl:null,error:r}}}async delete(e){try{const{fileId:r}=e,s=await m(`${this.url}/files/${r}`,{method:"DELETE",headers:this.generateAuthHeaders()});if(!s.ok)throw new Error(await s.text());return{error:null}}catch(r){return{error:r}}}setAccessToken(e){return this.accessToken=e,this}setAdminSecret(e){return this.adminSecret=e,this}generateAuthHeaders(){if(!(!this.adminSecret&&!this.accessToken))return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:{Authorization:`Bearer ${this.accessToken}`}}}function A(t,e){if(!e||Object.keys(e).length===0)return t;const r=new URL(t),s=Object.entries(e).reduce((a,[i,n])=>({...a,[i.charAt(0)]:n}),{});return Object.entries(s).forEach(([a,i])=>{i&&r.searchParams.set(a,i)}),r.toString()}class L{constructor({url:e,adminSecret:r}){this.url=e,this.api=new U({url:e}),this.setAdminSecret(r)}async upload(e){let r;return"file"in e?(r=new E,r.append("file",e.file)):r=e.formData,this.api.upload({...e,formData:r})}getPublicUrl(e){const{fileId:r,...s}=e;return A(`${this.url}/files/${r}`,s)}async getPresignedUrl(e){const{fileId:r,...s}=e,{presignedUrl:a,error:i}=await this.api.getPresignedUrl(e);if(i)return{presignedUrl:null,error:i};if(!a)return{presignedUrl:null,error:new Error("Invalid file id")};const n=A(a.url,s);return{presignedUrl:{...a,url:n},error:null}}async delete(e){const{error:r}=await this.api.delete(e);return r?{error:r}:{error:null}}setAccessToken(e){return this.api.setAccessToken(e),this}setAdminSecret(e){return this.api.setAdminSecret(e),this}}const h={progress:null,loaded:0,error:null,bucketId:void 0,file:void 0,id:void 0},y=()=>o.createMachine({predictableActionArguments:!0,schema:{context:{},events:{}},tsTypes:{},context:{...h},initial:"idle",on:{DESTROY:{actions:"sendDestroy",target:"stopped"}},states:{idle:{on:{ADD:{actions:"addFile"},UPLOAD:{cond:"hasFile",target:"uploading"}}},uploading:{entry:"resetProgress",on:{UPLOAD_PROGRESS:{actions:["incrementProgress","sendProgress"]},UPLOAD_DONE:"uploaded",UPLOAD_ERROR:"error",CANCEL:"idle"},invoke:{src:"uploadFile"}},uploaded:{entry:["setFileMetadata","sendDone"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},error:{entry:["setError","sendError"],on:{ADD:{actions:"addFile",target:"idle"},UPLOAD:{actions:"resetContext",target:"uploading"}}},stopped:{type:"final"}}},{guards:{hasFile:(t,e)=>!!t.file||!!e.file},actions:{incrementProgress:o.assign({loaded:(t,{loaded:e})=>e,progress:(t,{progress:e})=>e}),setFileMetadata:o.assign({id:(t,{id:e})=>e,bucketId:(t,{bucketId:e})=>e,progress:t=>100}),setError:o.assign({error:(t,{error:e})=>e}),sendProgress:()=>{},sendError:()=>{},sendDestroy:()=>{},sendDone:()=>{},resetProgress:o.assign({progress:t=>null,loaded:t=>0}),resetContext:o.assign(t=>h),addFile:o.assign({file:(t,{file:e})=>e,bucketId:(t,{bucketId:e})=>e,id:(t,{id:e})=>e})},services:{uploadFile:(t,e)=>r=>{const s=e.file||t.file,a=new E;a.append("file",s);let i=0;return O(e.url,a,{fileId:e.id||t.id,bucketId:e.bucketId||t.bucketId,accessToken:e.accessToken,adminSecret:e.adminSecret,name:e.name||s.name,onUploadProgress:n=>{const l=n.total?Math.round(n.loaded*s.size/n.total):0,c=l-i;i=l,r({type:"UPLOAD_PROGRESS",progress:n.total?Math.round(l*100/n.total):0,loaded:l,additions:c})}}).then(({fileMetadata:n,error:l})=>{if(l&&r({type:"UPLOAD_ERROR",error:l}),n){const{id:c,bucketId:p}=n;r({type:"UPLOAD_DONE",id:c,bucketId:p})}}),()=>{}}}}),{pure:f,sendParent:g}=o.actions,S=()=>o.createMachine({id:"files-list",schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,context:{progress:null,files:[],loaded:0,total:0},initial:"idle",on:{UPLOAD:{cond:"hasFileToDownload",actions:"addItem",target:"uploading"},ADD:{actions:"addItem"},REMOVE:{actions:"removeItem"}},states:{idle:{entry:["resetProgress","resetLoaded","resetTotal"],on:{CLEAR:{actions:"clearList",target:"idle"}}},uploading:{entry:["upload","startProgress","resetLoaded","resetTotal"],on:{UPLOAD_PROGRESS:{actions:["incrementProgress"]},UPLOAD_DONE:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],UPLOAD_ERROR:[{cond:"isAllUploaded",target:"uploaded"},{cond:"isAllUploadedOrError",target:"error"}],CANCEL:{actions:"cancel",target:"idle"}}},uploaded:{entry:"setUploaded",on:{CLEAR:{actions:"clearList",target:"idle"}}},error:{on:{CLEAR:{actions:"clearList",target:"idle"}}}}},{guards:{hasFileToDownload:(t,e)=>t.files.some(r=>r.getSnapshot().matches("idle"))||!!e.files,isAllUploaded:t=>t.files.every(e=>{var r;return(r=e.getSnapshot())==null?void 0:r.matches("uploaded")}),isAllUploadedOrError:t=>t.files.every(e=>{const r=e.getSnapshot();return(r==null?void 0:r.matches("error"))||(r==null?void 0:r.matches("uploaded"))})},actions:{incrementProgress:o.assign((t,e)=>{const r=t.loaded+e.additions,s=Math.round(r*100/t.total);return{...t,loaded:r,progress:s}}),setUploaded:o.assign({progress:t=>100,loaded:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetTotal:o.assign({total:({files:t})=>t.map(e=>e.getSnapshot()).filter(e=>!e.matches("uploaded")).reduce((e,r)=>{var s;return e+((s=r.context.file)==null?void 0:s.size)},0)}),resetLoaded:o.assign({loaded:t=>0}),startProgress:o.assign({progress:t=>0}),resetProgress:o.assign({progress:t=>null}),addItem:o.assign((t,{files:e,bucketId:r})=>{const s=e?Array.isArray(e)?e:"item"in e?Array.from(e):[e]:[],a=t.total+s.reduce((n,l)=>n+l.size,0),i=Math.round(t.loaded*100/a);return{files:[...t.files,...s.map(n=>o.spawn(y().withConfig({actions:{sendProgress:g((l,{additions:c})=>({type:"UPLOAD_PROGRESS",additions:c})),sendDone:g("UPLOAD_DONE"),sendError:g("UPLOAD_ERROR"),sendDestroy:g("REMOVE")}}).withContext({...h,file:n,bucketId:r}),{sync:!0}))],total:a,loaded:t.loaded,progress:i}}),removeItem:o.assign({files:t=>t.files.filter(e=>{var s,a;const r=(s=e.getSnapshot())==null?void 0:s.matches("stopped");return r&&((a=e.stop)==null||a.call(e)),!r})}),clearList:f(t=>t.files.map(e=>o.send({type:"DESTROY"},{to:e.id}))),upload:f((t,e)=>t.files.map(r=>o.send(e,{to:r.id}))),cancel:f(t=>t.files.map(e=>o.send({type:"CANCEL"},{to:e.id})))}}),_=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t}),e.subscribe(s=>{var a;s.matches("error")?r({error:s.context.error,isError:!0,isUploaded:!1}):s.matches("uploaded")&&r({error:null,isError:!1,isUploaded:!0,id:s.context.id,bucketId:s.context.id,name:(a=s.context.file)==null?void 0:a.name})})}),I=async(t,e)=>new Promise(r=>{e.send({type:"UPLOAD",...t,files:t.files}),e.onTransition(s=>{s.matches("error")?r({errors:s.context.files.filter(a=>{var i;return(i=a.getSnapshot())==null?void 0:i.context.error}),isError:!0,files:[]}):s.matches("uploaded")&&r({errors:[],isError:!1,files:s.context.files})})});exports.HasuraStorageApi=U;exports.HasuraStorageClient=L;exports.INITIAL_FILE_CONTEXT=h;exports.appendImageTransformationParameters=A;exports.createFileUploadMachine=y;exports.createMultipleFilesUploadMachine=S;exports.uploadFilePromise=_;exports.uploadMultipleFilesPromise=I;
//# sourceMappingURL=index.cjs.js.map
