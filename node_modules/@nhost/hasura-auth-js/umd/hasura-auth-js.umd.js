(function(y,X){typeof exports=="object"&&typeof module!="undefined"?X(exports):typeof define=="function"&&define.amd?define(["exports"],X):(y=typeof globalThis!="undefined"?globalThis:y||self,X(y["@nhost/hasura-auth-js"]={}))})(this,function(y){"use strict";const X="nhostRefreshToken",Re="nhostRefreshTokenExpiresAt";class Ae extends Error{constructor(e){super(e.message),Error.captureStackTrace(this,this.constructor),e instanceof Error?(this.name=e.name,this.error={error:e.name,status:1,message:e.message}):(this.name=e.error,this.error=e)}}const Z={status:10,error:"invalid-email",message:"Email is incorrectly formatted"},kt={status:10,error:"invalid-mfa-type",message:"MFA type is invalid"},Ct={status:10,error:"invalid-mfa-code",message:"MFA code is invalid"},Me={status:10,error:"invalid-password",message:"Password is incorrectly formatted"},it={status:10,error:"invalid-phone-number",message:"Phone number is incorrectly formatted"},Dt={status:10,error:"invalid-mfa-ticket",message:"MFA ticket is invalid"},Mt={status:10,error:"no-mfa-ticket",message:"No MFA ticket has been provided"},Ut={status:10,error:"no-refresh-token",message:"No refresh token has been provided"},Lt={status:20,error:"refresher-already-running",message:"The token refresher is already running. You must wait until is has finished before submitting a new token."},Q={status:20,error:"already-signed-in",message:"User is already signed in"},jt={status:20,error:"unauthenticated-user",message:"User is not authenticated"},$r={status:20,error:"user-not-anonymous",message:"User is not anonymous"},Vt={status:20,error:"unverified-user",message:"Email needs verification"},Kt={status:10,error:"invalid-refresh-token",message:"Invalid or expired refresh token"},Gt={status:1,error:"invalid-sign-in-method",message:"Invalid sign-in method"};function st(t){this.message=t}st.prototype=new Error,st.prototype.name="InvalidCharacterError";var Ft=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new st("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,i=0,s=0,o="";n=e.charAt(s++);~n&&(r=i%4?64*r+n:n,i++%4)?o+=String.fromCharCode(255&r>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function Hr(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(r){return decodeURIComponent(Ft(r).replace(/(.)/g,function(n,i){var s=i.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch{return Ft(e)}}function Ue(t){this.message=t}function Wr(t,e){if(typeof t!="string")throw new Ue("Invalid token specified");var r=(e=e||{}).header===!0?0:1;try{return JSON.parse(Hr(t.split(".")[r]))}catch(n){throw new Ue("Invalid token specified: "+n.message)}}Ue.prototype=new Error,Ue.prototype.name="InvalidTokenError";/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var p=function(){return p=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},p.apply(this,arguments)};function ot(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function R(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function A(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(c){o={error:c}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function C(t,e,r){if(r||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))}var P;(function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication",t.ErrorPlatform="error.platform",t.ErrorCustom="xstate.error",t.Update="xstate.update",t.Pure="xstate.pure",t.Choose="xstate.choose"})(P||(P={}));var ne;(function(t){t.Parent="#_parent",t.Internal="#_internal"})(ne||(ne={}));var at=P.Start,ct=P.Stop,ue=P.Raise,le=P.Send,$t=P.Cancel,qr=P.NullEvent,ut=P.Assign;P.After,P.DoneState;var Ht=P.Log,Yr=P.Init,lt=P.Invoke;P.ErrorExecution;var Wt=P.ErrorPlatform,zr=P.ErrorCustom,qt=P.Update,Br=P.Choose,Qr=P.Pure,Yt=".",zt={},ft="xstate.guard",Jr="",j=process.env.NODE_ENV==="production",Le;function dt(t,e,r){r===void 0&&(r=Yt);var n=Oe(t,r),i=Oe(e,r);return b(i)?b(n)?i===n:!1:b(n)?n in i:Object.keys(n).every(function(s){return s in i?dt(n[s],i[s]):!1})}function Bt(t){try{return b(t)||typeof t=="number"?"".concat(t):t.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function ht(t,e){try{return fe(t)?t:t.toString().split(e)}catch{throw new Error("'".concat(t,"' is not a valid state path."))}}function Xr(t){return typeof t=="object"&&"value"in t&&"context"in t&&"event"in t&&"_event"in t}function Oe(t,e){if(Xr(t))return t.value;if(fe(t))return je(t);if(typeof t!="string")return t;var r=ht(t,e);return je(r)}function je(t){if(t.length===1)return t[0];for(var e={},r=e,n=0;n<t.length-1;n++)n===t.length-2?r[t[n]]=t[n+1]:(r[t[n]]={},r=r[t[n]]);return e}function _e(t,e){for(var r={},n=Object.keys(t),i=0;i<n.length;i++){var s=n[i];r[s]=e(t[s],s,t,i)}return r}function Qt(t,e,r){var n,i,s={};try{for(var o=R(Object.keys(t)),c=o.next();!c.done;c=o.next()){var l=c.value,d=t[l];r(d)&&(s[l]=e(d,l,t))}}catch(a){n={error:a}}finally{try{c&&!c.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}var Zr=function(t){return function(e){var r,n,i=e;try{for(var s=R(t),o=s.next();!o.done;o=s.next()){var c=o.value;i=i[c]}}catch(l){r={error:l}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}};function en(t,e){return function(r){var n,i,s=r;try{for(var o=R(t),c=o.next();!c.done;c=o.next()){var l=c.value;s=s[e][l]}}catch(d){n={error:d}}finally{try{c&&!c.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}}function Ve(t){if(!t)return[[]];if(b(t))return[[t]];var e=U(Object.keys(t).map(function(r){var n=t[r];return typeof n!="string"&&(!n||!Object.keys(n).length)?[[r]]:Ve(t[r]).map(function(i){return[r].concat(i)})}));return e}function U(t){var e;return(e=[]).concat.apply(e,C([],A(t),!1))}function Jt(t){return fe(t)?t:[t]}function q(t){return t===void 0?[]:Jt(t)}function Ke(t,e,r){var n,i;if(k(t))return t(e,r.data);var s={};try{for(var o=R(Object.keys(t)),c=o.next();!c.done;c=o.next()){var l=c.value,d=t[l];k(d)?s[l]=d(e,r.data):s[l]=d}}catch(a){n={error:a}}finally{try{c&&!c.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function tn(t){return/^(done|error)\./.test(t)}function Xt(t){return!!(t instanceof Promise||t!==null&&(k(t)||typeof t=="object")&&k(t.then))}function rn(t){return t!==null&&typeof t=="object"&&"transition"in t&&typeof t.transition=="function"}function nn(t,e){var r,n,i=A([[],[]],2),s=i[0],o=i[1];try{for(var c=R(t),l=c.next();!l.done;l=c.next()){var d=l.value;e(d)?s.push(d):o.push(d)}}catch(a){r={error:a}}finally{try{l&&!l.done&&(n=c.return)&&n.call(c)}finally{if(r)throw r.error}}return[s,o]}function Zt(t,e){return _e(t.states,function(r,n){if(r){var i=(b(e)?void 0:e[n])||(r?r.current:void 0);if(i)return{current:i,states:Zt(r,i)}}})}function sn(t,e){return{current:e,states:Zt(t,e)}}function er(t,e,r,n){j||K(!!t,"Attempting to update undefined context");var i=t&&r.reduce(function(s,o){var c,l,d=o.assignment,a={state:n,action:o,_event:e},f={};if(k(d))f=d(s,e.data,a);else try{for(var u=R(Object.keys(d)),h=u.next();!h.done;h=u.next()){var v=h.value,m=d[v];f[v]=k(m)?m(s,e.data,a):m}}catch(E){c={error:E}}finally{try{h&&!h.done&&(l=u.return)&&l.call(u)}finally{if(c)throw c.error}}return Object.assign({},s,f)},t);return i}var K=function(){};j||(K=function(t,e){var r=t instanceof Error?t:void 0;if(!(!r&&t)&&console!==void 0){var n=["Warning: ".concat(e)];r&&n.push(r),console.warn.apply(console,n)}});function fe(t){return Array.isArray(t)}function k(t){return typeof t=="function"}function b(t){return typeof t=="string"}function tr(t,e){if(t)return b(t)?{type:ft,name:t,predicate:e?e[t]:void 0}:k(t)?{type:ft,name:t.name,predicate:t}:t}function on(t){try{return"subscribe"in t&&k(t.subscribe)}catch{return!1}}var ie=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Le={},Le[ie]=function(){return this},Le[Symbol.observable]=function(){return this};function ae(t){return!!t&&"__xstatenode"in t}function an(t){return!!t&&typeof t.send=="function"}function vt(t,e){return b(t)||typeof t=="number"?p({type:t},e):t}function G(t,e){if(!b(t)&&"$$type"in t&&t.$$type==="scxml")return t;var r=vt(t);return p({name:r.type,data:r,$$type:"scxml",type:"external"},e)}function de(t,e){var r=Jt(e).map(function(n){return typeof n=="undefined"||typeof n=="string"||ae(n)?{target:n,event:t}:p(p({},n),{event:t})});return r}function cn(t){if(!(t===void 0||t===Jr))return q(t)}function un(t,e,r){if(!j){var n=t.stack?" Stacktrace was '".concat(t.stack,"'"):"";if(t===e)console.error("Missing onError handler for invocation '".concat(r,"', error was '").concat(t,"'.").concat(n));else{var i=e.stack?" Stacktrace was '".concat(e.stack,"'"):"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '".concat(r,"'. ")+"Original error: '".concat(t,"'. ").concat(n," Current error is '").concat(e,"'.").concat(i))}}}function rr(t,e,r,n,i){var s=t.options.guards,o={state:i,cond:e,_event:n};if(e.type===ft)return((s==null?void 0:s[e.name])||e.predicate)(r,n.data,o);var c=s==null?void 0:s[e.type];if(!c)throw new Error("Guard '".concat(e.type,"' is not implemented on machine '").concat(t.id,"'."));return c(r,n.data,o)}function nr(t){return typeof t=="string"?{type:t}:t}function Ge(t,e,r){var n=function(){},i=typeof t=="object",s=i?t:null;return{next:((i?t.next:t)||n).bind(s),error:((i?t.error:e)||n).bind(s),complete:((i?t.complete:r)||n).bind(s)}}function Fe(t,e){return"".concat(t,":invocation[").concat(e,"]")}var he=G({type:Yr});function pt(t,e){return e&&e[t]||void 0}function be(t,e){var r;if(b(t)||typeof t=="number"){var n=pt(t,e);k(n)?r={type:t,exec:n}:n?r=n:r={type:t,exec:void 0}}else if(k(t))r={type:t.name||t.toString(),exec:t};else{var n=pt(t.type,e);if(k(n))r=p(p({},t),{exec:n});else if(n){var i=n.type||t.type;r=p(p(p({},n),t),{type:i})}else r=t}return r}var se=function(t,e){if(!t)return[];var r=fe(t)?t:[t];return r.map(function(n){return be(n,e)})};function yt(t){var e=be(t);return p(p({id:b(t)?t:e.id},e),{type:e.type})}function ln(t){return b(t)?{type:ue,event:t}:mt(t,{to:ne.Internal})}function fn(t){return{type:ue,_event:G(t.event)}}function mt(t,e){return{to:e?e.to:void 0,type:le,event:k(t)?t:vt(t),delay:e?e.delay:void 0,id:e&&e.id!==void 0?e.id:k(t)?t.name:Bt(t)}}function dn(t,e,r,n){var i={_event:r},s=G(k(t.event)?t.event(e,r.data,i):t.event),o;if(b(t.delay)){var c=n&&n[t.delay];o=k(c)?c(e,r.data,i):c}else o=k(t.delay)?t.delay(e,r.data,i):t.delay;var l=k(t.to)?t.to(e,r.data,i):t.to;return p(p({},t),{to:l,_event:s,event:s.data,delay:o})}var hn=function(t,e,r){return p(p({},t),{value:b(t.expr)?t.expr:t.expr(e,r.data,{_event:r})})},vn=function(t){return{type:$t,sendId:t}};function pn(t){var e=yt(t);return{type:P.Start,activity:e,exec:void 0}}function yn(t){var e=k(t)?t:yt(t);return{type:P.Stop,activity:e,exec:void 0}}function mn(t,e,r){var n=k(t.activity)?t.activity(e,r.data):t.activity,i=typeof n=="string"?{id:n}:n,s={type:P.Stop,activity:i};return s}var gn=function(t){return{type:ut,assignment:t}};function En(t,e){var r=e?"#".concat(e):"";return"".concat(P.After,"(").concat(t,")").concat(r)}function $e(t,e){var r="".concat(P.DoneState,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function He(t,e){var r="".concat(P.DoneInvoke,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function Ie(t,e){var r="".concat(P.ErrorPlatform,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}var wn=function(t){var e,r,n=[];try{for(var i=R(t),s=i.next();!s.done;s=i.next())for(var o=s.value,c=0;c<o.length;){if(o[c].type===ut){n.push(o[c]),o.splice(c,1);continue}c++}}catch(l){e={error:l}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n};function We(t,e,r,n,i,s,o){o===void 0&&(o=!1);var c=o?[]:wn(i),l=c.length?er(r,n,c,e):r,d=o?[r]:void 0,a=[];function f(v){var m;switch(v.type){case ue:return fn(v);case le:var E=dn(v,l,n,t.options.delays);return j||K(!b(v.delay)||typeof E.delay=="number","No delay reference for delay expression '".concat(v.delay,"' was found on machine '").concat(t.id,"'")),s&&E.to!==ne.Internal&&a.push(E),E;case Ht:{var S=hn(v,l,n);return s==null||s(S,l,n),S}case Br:{var g=v,w=(m=g.conds.find(function(z){var re=tr(z.cond,t.options.guards);return!re||rr(t,re,l,n,s?void 0:e)}))===null||m===void 0?void 0:m.actions;if(!w)return[];var N=A(We(t,e,l,n,[se(q(w),t.options.actions)],s,o),2),O=N[0],M=N[1];return l=M,d==null||d.push(l),O}case Qr:{var w=v.get(l,n.data);if(!w)return[];var _=A(We(t,e,l,n,[se(q(w),t.options.actions)],s,o),2),I=_[0],x=_[1];return l=x,d==null||d.push(l),I}case ct:{var S=mn(v,l,n);return s==null||s(S,r,n),S}case ut:{l=er(l,n,[v],s?void 0:e),d==null||d.push(l);break}default:var T=be(v,t.options.actions),D=T.exec;if(s)s(T,l,n);else if(D&&d){var W=d.length-1;T=p(p({},T),{exec:function(z){for(var re=[],we=1;we<arguments.length;we++)re[we-1]=arguments[we];D.apply(void 0,C([d[W]],A(re),!1))}})}return T}}function u(v){var m,E,S=[];try{for(var g=R(v),w=g.next();!w.done;w=g.next()){var N=w.value,O=f(N);O&&(S=S.concat(O))}}catch(M){m={error:M}}finally{try{w&&!w.done&&(E=g.return)&&E.call(g)}finally{if(m)throw m.error}}return a.forEach(function(M){s(M,l,n)}),a.length=0,S}var h=U(i.map(u));return[h,l]}var ve=function(t,e){var r=e(t);return r};function ir(t){var e;return e={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:t}}},e[ie]=function(){return this},e}function Sn(t,e,r,n){var i,s=nr(t.src),o=(i=e==null?void 0:e.options.services)===null||i===void 0?void 0:i[s.type],c=t.data?Ke(t.data,r,n):void 0,l=o?sr(o,t.id,c):ir(t.id);return l.meta=t,l}function sr(t,e,r){var n=ir(e);if(n.deferred=!0,ae(t)){var i=n.state=ve(void 0,function(){return(r?t.withContext(r):t).initialState});n.getSnapshot=function(){return i}}return n}function Tn(t){try{return typeof t.send=="function"}catch{return!1}}function Rn(t){return Tn(t)&&"id"in t}function An(t){var e;return p((e={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e[ie]=function(){return this},e),t)}var qe=function(t){return t.type==="atomic"||t.type==="final"};function or(t){return Object.keys(t.states).map(function(e){return t.states[e]})}function Ne(t){return or(t).filter(function(e){return e.type!=="history"})}function ar(t){var e=[t];return qe(t)?e:e.concat(U(Ne(t).map(ar)))}function xe(t,e){var r,n,i,s,o,c,l,d,a=new Set(t),f=gt(a),u=new Set(e);try{for(var h=R(u),v=h.next();!v.done;v=h.next())for(var m=v.value,E=m.parent;E&&!u.has(E);)u.add(E),E=E.parent}catch(x){r={error:x}}finally{try{v&&!v.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}var S=gt(u);try{for(var g=R(u),w=g.next();!w.done;w=g.next()){var m=w.value;if(m.type==="compound"&&(!S.get(m)||!S.get(m).length))f.get(m)?f.get(m).forEach(function(T){return u.add(T)}):m.initialStateNodes.forEach(function(T){return u.add(T)});else if(m.type==="parallel")try{for(var N=(o=void 0,R(Ne(m))),O=N.next();!O.done;O=N.next()){var M=O.value;u.has(M)||(u.add(M),f.get(M)?f.get(M).forEach(function(T){return u.add(T)}):M.initialStateNodes.forEach(function(T){return u.add(T)}))}}catch(T){o={error:T}}finally{try{O&&!O.done&&(c=N.return)&&c.call(N)}finally{if(o)throw o.error}}}}catch(x){i={error:x}}finally{try{w&&!w.done&&(s=g.return)&&s.call(g)}finally{if(i)throw i.error}}try{for(var _=R(u),I=_.next();!I.done;I=_.next())for(var m=I.value,E=m.parent;E&&!u.has(E);)u.add(E),E=E.parent}catch(x){l={error:x}}finally{try{I&&!I.done&&(d=_.return)&&d.call(_)}finally{if(l)throw l.error}}return u}function cr(t,e){var r=e.get(t);if(!r)return{};if(t.type==="compound"){var n=r[0];if(n){if(qe(n))return n.key}else return{}}var i={};return r.forEach(function(s){i[s.key]=cr(s,e)}),i}function gt(t){var e,r,n=new Map;try{for(var i=R(t),s=i.next();!s.done;s=i.next()){var o=s.value;n.has(o)||n.set(o,[]),o.parent&&(n.has(o.parent)||n.set(o.parent,[]),n.get(o.parent).push(o))}}catch(c){e={error:c}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n}function On(t,e){var r=xe([t],e);return cr(t,gt(r))}function Pe(t,e){return Array.isArray(t)?t.some(function(r){return r===e}):t instanceof Set?t.has(e):!1}function _n(t){return C([],A(new Set(U(C([],A(t.map(function(e){return e.ownEvents})),!1)))),!1)}function Ye(t,e){return e.type==="compound"?Ne(e).some(function(r){return r.type==="final"&&Pe(t,r)}):e.type==="parallel"?Ne(e).every(function(r){return Ye(t,r)}):!1}function bn(t){return t===void 0&&(t=[]),t.reduce(function(e,r){return r.meta!==void 0&&(e[r.id]=r.meta),e},{})}function ur(t){return new Set(U(t.map(function(e){return e.tags})))}function lr(t,e){if(t===e)return!0;if(t===void 0||e===void 0)return!1;if(b(t)||b(e))return t===e;var r=Object.keys(t),n=Object.keys(e);return r.length===n.length&&r.every(function(i){return lr(t[i],e[i])})}function In(t){return typeof t!="object"||t===null?!1:"value"in t&&"_event"in t}function Nn(t,e){var r=t.exec,n=p(p({},t),{exec:r!==void 0?function(){return r(e.context,e.event,{action:t,state:e,_event:e._event})}:void 0});return n}var J=function(){function t(e){var r=this,n;this.actions=[],this.activities=zt,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||zt,this.meta=bn(e.configuration),this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,this.tags=(n=Array.isArray(e.tags)?new Set(e.tags):e.tags)!==null&&n!==void 0?n:new Set,this.machine=e.machine,Object.defineProperty(this,"nextEvents",{get:function(){return _n(r.configuration)}})}return t.from=function(e,r){if(e instanceof t)return e.context!==r?new t({value:e.value,context:r,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var n=he;return new t({value:e,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},t.create=function(e){return new t(e)},t.inert=function(e,r){if(e instanceof t){if(!e.actions.length)return e;var n=he;return new t({value:e.value,context:r,_event:n,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return t.from(e,r)},t.prototype.toStrings=function(e,r){var n=this;if(e===void 0&&(e=this.value),r===void 0&&(r="."),b(e))return[e];var i=Object.keys(e);return i.concat.apply(i,C([],A(i.map(function(s){return n.toStrings(e[s],r).map(function(o){return s+r+o})})),!1))},t.prototype.toJSON=function(){var e=this;e.configuration,e.transitions;var r=e.tags;e.machine;var n=ot(e,["configuration","transitions","tags","machine"]);return p(p({},n),{tags:Array.from(r)})},t.prototype.matches=function(e){return dt(e,this.value)},t.prototype.hasTag=function(e){return this.tags.has(e)},t.prototype.can=function(e){var r;j&&K(!!this.machine,"state.can(...) used outside of a machine-created State object; this will always return false.");var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,e);return!!(n!=null&&n.transitions.length)&&n.transitions.some(function(i){return i.target!==void 0||i.actions.length})},t}(),xn={deferEvents:!1},fr=function(){function t(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=p(p({},xn),e)}return t.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},t.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},t.prototype.clear=function(){this.queue=[]},t.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},t.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},t}(),Et=new Map,Pn=0,ze={bookId:function(){return"x:".concat(Pn++)},register:function(t,e){return Et.set(t,e),t},get:function(t){return Et.get(t)},free:function(t){Et.delete(t)}};function wt(){if(typeof globalThis!="undefined")return globalThis;if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global;j||console.warn("XState could not find a global object in this environment. Please let the maintainers know and raise an issue here: https://github.com/statelyai/xstate/issues")}function kn(){var t=wt();if(t&&"__xstate__"in t)return t.__xstate__}function Cn(t){if(wt()){var e=kn();e&&e.register(t)}}function Dn(t,e){e===void 0&&(e={});var r=t.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var d=i.shift();r=t.transition(r,d,l),n.forEach(function(a){return a.next(r)})}s=!1}},c=An({id:e.id,send:function(d){i.push(d),o()},getSnapshot:function(){return r},subscribe:function(d,a,f){var u=Ge(d,a,f);return n.add(u),u.next(r),{unsubscribe:function(){n.delete(u)}}}}),l={parent:e.parent,self:c,id:e.id||"anonymous",observers:n};return r=t.start?t.start(l):r,c}var Mn={sync:!1,autoForward:!1},V;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"})(V||(V={}));var Un=function(){function t(e,r){r===void 0&&(r=t.defaultOptions);var n=this;this.machine=e,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=V.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(a,f){if(fe(a))return n.batch(a),n.state;var u=G(vt(a,f));if(n.status===V.Stopped)return j||K(!1,'Event "'.concat(u.name,'" was sent to stopped service "').concat(n.machine.id,`". This service has already reached its final state, and will not transition.
Event: `).concat(JSON.stringify(u.data))),n.state;if(n.status!==V.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(u.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(u.data)));return n.scheduler.schedule(function(){n.forward(u);var h=n._nextState(u);n.update(h,u)}),n._state},this.sendTo=function(a,f,u){var h=n.parent&&(f===ne.Parent||n.parent.id===f),v=h?n.parent:b(f)?n.children.get(f)||ze.get(f):an(f)?f:void 0;if(!v){if(!h)throw new Error("Unable to send event to child '".concat(f,"' from service '").concat(n.id,"'."));j||K(!1,"Service '".concat(n.id,"' has no parent: unable to send event ").concat(a.type));return}if("machine"in v){if(n.status!==V.Stopped||n.parent!==v||n.state.done){var m=p(p({},a),{name:a.name===zr?"".concat(Ie(n.id)):a.name,origin:n.sessionId});!u&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,m]):v.send(m)}}else!u&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,a.data]):v.send(a.data)},this._exec=function(a,f,u,h){h===void 0&&(h=n.machine.options.actions);var v=a.exec||pt(a.type,h),m=k(v)?v:v?v.exec:a.exec;if(m)try{return m(f,u.data,n.machine.config.predictableActionArguments?{action:a,_event:u}:{action:a,state:n.state,_event:u})}catch(W){throw n.parent&&n.parent.send({type:"xstate.error",data:W}),W}switch(a.type){case le:var E=a;if(typeof E.delay=="number"){n.defer(E);return}else E.to?n.sendTo(E._event,E.to,u===he):n.send(E._event);break;case $t:n.cancel(a.sendId);break;case at:{if(n.status!==V.Running)return;var S=a.activity;if(!n.machine.config.predictableActionArguments&&!n.state.activities[S.id||S.type])break;if(S.type===P.Invoke){var g=nr(S.src),w=n.machine.options.services?n.machine.options.services[g.type]:void 0,N=S.id,O=S.data;j||K(!("forward"in S),"`forward` property is deprecated (found in invocation of '".concat(S.src,"' in in machine '").concat(n.machine.id,"'). ")+"Please use `autoForward` instead.");var M="autoForward"in S?S.autoForward:!!S.forward;if(!w){j||K(!1,"No service found for invocation '".concat(S.src,"' in machine '").concat(n.machine.id,"'."));return}var _=O?Ke(O,f,u):void 0;if(typeof w=="string")return;var I=k(w)?w(f,u.data,{data:_,src:g,meta:S.meta}):w;if(!I)return;var x=void 0;ae(I)&&(I=_?I.withContext(_):I,x={autoForward:M}),n.spawn(I,N,x)}else n.spawnActivity(S);break}case ct:{n.stopChild(a.activity.id);break}case Ht:var T=a.label,D=a.value;T?n.logger(T,D):n.logger(D);break;default:j||K(!1,"No implementation found for action type '".concat(a.type,"'"));break}};var i=p(p({},t.defaultOptions),r),s=i.clock,o=i.logger,c=i.parent,l=i.id,d=l!==void 0?l:e.id;this.id=d,this.logger=o,this.clock=s,this.parent=c,this.options=i,this.scheduler=new fr({deferEvents:this.options.deferEvents}),this.sessionId=ze.bookId()}return Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:ve(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return j||K(this.status!==V.NotStarted,"Attempted to read state from uninitialized service '".concat(this.id,"'. Make sure the service is started first.")),this._state},enumerable:!1,configurable:!0}),t.prototype.execute=function(e,r){var n,i;try{for(var s=R(e.actions),o=s.next();!o.done;o=s.next()){var c=o.value;this.exec(c,e,r)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},t.prototype.update=function(e,r){var n,i,s,o,c,l,d,a,f=this;if(e._sessionid=this.sessionId,this._state=e,(!this.machine.config.predictableActionArguments||r===he)&&this.options.execute)this.execute(this.state);else for(var u=void 0;u=this._outgoingQueue.shift();)u[0].send(u[1]);if(this.children.forEach(function(x){f.state.children[x.id]=x}),this.devTools&&this.devTools.send(r.data,e),e.event)try{for(var h=R(this.eventListeners),v=h.next();!v.done;v=h.next()){var m=v.value;m(e.event)}}catch(x){n={error:x}}finally{try{v&&!v.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}try{for(var E=R(this.listeners),S=E.next();!S.done;S=E.next()){var m=S.value;m(e,e.event)}}catch(x){s={error:x}}finally{try{S&&!S.done&&(o=E.return)&&o.call(E)}finally{if(s)throw s.error}}try{for(var g=R(this.contextListeners),w=g.next();!w.done;w=g.next()){var N=w.value;N(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(x){c={error:x}}finally{try{w&&!w.done&&(l=g.return)&&l.call(g)}finally{if(c)throw c.error}}if(this.state.done){var O=e.configuration.find(function(x){return x.type==="final"&&x.parent===f.machine}),M=O&&O.doneData?Ke(O.doneData,e.context,r):void 0;try{for(var _=R(this.doneListeners),I=_.next();!I.done;I=_.next()){var m=I.value;m(He(this.id,M))}}catch(x){d={error:x}}finally{try{I&&!I.done&&(a=_.return)&&a.call(_)}finally{if(d)throw d.error}}this._stop(),this._stopChildren()}},t.prototype.onTransition=function(e){return this.listeners.add(e),this.status===V.Running&&e(this.state,this.state.event),this},t.prototype.subscribe=function(e,r,n){var i=this,s=Ge(e,r,n);this.listeners.add(s.next),this.status!==V.NotStarted&&s.next(this.state);var o=function(){i.doneListeners.delete(o),i.stopListeners.delete(o),s.complete()};return this.status===V.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){i.listeners.delete(s.next),i.doneListeners.delete(o),i.stopListeners.delete(o)}}},t.prototype.onEvent=function(e){return this.eventListeners.add(e),this},t.prototype.onSend=function(e){return this.sendListeners.add(e),this},t.prototype.onChange=function(e){return this.contextListeners.add(e),this},t.prototype.onStop=function(e){return this.stopListeners.add(e),this},t.prototype.onDone=function(e){return this.doneListeners.add(e),this},t.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},t.prototype.start=function(e){var r=this;if(this.status===V.Running)return this;this.machine._init(),ze.register(this.sessionId,this),this.initialized=!0,this.status=V.Running;var n=e===void 0?this.initialState:ve(this,function(){return In(e)?r.machine.resolveState(e):r.machine.resolveState(J.from(e,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,he)}),this},t.prototype._stopChildren=function(){this.children.forEach(function(e){k(e.stop)&&e.stop()}),this.children.clear()},t.prototype._stop=function(){var e,r,n,i,s,o,c,l,d,a;try{for(var f=R(this.listeners),u=f.next();!u.done;u=f.next()){var h=u.value;this.listeners.delete(h)}}catch(_){e={error:_}}finally{try{u&&!u.done&&(r=f.return)&&r.call(f)}finally{if(e)throw e.error}}try{for(var v=R(this.stopListeners),m=v.next();!m.done;m=v.next()){var h=m.value;h(),this.stopListeners.delete(h)}}catch(_){n={error:_}}finally{try{m&&!m.done&&(i=v.return)&&i.call(v)}finally{if(n)throw n.error}}try{for(var E=R(this.contextListeners),S=E.next();!S.done;S=E.next()){var h=S.value;this.contextListeners.delete(h)}}catch(_){s={error:_}}finally{try{S&&!S.done&&(o=E.return)&&o.call(E)}finally{if(s)throw s.error}}try{for(var g=R(this.doneListeners),w=g.next();!w.done;w=g.next()){var h=w.value;this.doneListeners.delete(h)}}catch(_){c={error:_}}finally{try{w&&!w.done&&(l=g.return)&&l.call(g)}finally{if(c)throw c.error}}if(!this.initialized)return this;this.initialized=!1,this.status=V.Stopped,this._initialState=void 0;try{for(var N=R(Object.keys(this.delayedEventsMap)),O=N.next();!O.done;O=N.next()){var M=O.value;this.clock.clearTimeout(this.delayedEventsMap[M])}}catch(_){d={error:_}}finally{try{O&&!O.done&&(a=N.return)&&a.call(N)}finally{if(d)throw d.error}}this.scheduler.clear(),this.scheduler=new fr({deferEvents:this.options.deferEvents})},t.prototype.stop=function(){var e=this,r=this.scheduler;return this._stop(),r.schedule(function(){var n=G({type:"xstate.stop"}),i=ve(e,function(){var s=U(C([],A(e.state.configuration),!1).sort(function(a,f){return f.order-a.order}).map(function(a){return se(a.onExit,e.machine.options.actions)})),o=A(We(e.machine,e.state,e.state.context,n,[s],e.machine.config.predictableActionArguments?e._exec:void 0,e.machine.config.predictableActionArguments||e.machine.config.preserveActionOrder),2),c=o[0],l=o[1],d=new J({value:e.state.value,context:l,_event:n,_sessionid:e.sessionId,historyValue:void 0,history:e.state,actions:c.filter(function(a){return a.type!==ue&&(a.type!==le||!!a.to&&a.to!==ne.Internal)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:e.state.done,tags:e.state.tags,machine:e.machine});return d.changed=!0,d});e.update(i,n),e._stopChildren(),ze.free(e.sessionId)}),this},t.prototype.batch=function(e){var r=this;if(this.status===V.NotStarted&&this.options.deferEvents)j||K(!1,"".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,`" and are deferred. Make sure .start() is called for this service.
Event: `).concat(JSON.stringify(event)));else if(this.status!==V.Running)throw new Error("".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(e.length){var n=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,s,o=r.state,c=!1,l=[],d=function(h){var v=G(h);r.forward(v),o=ve(r,function(){return r.machine.transition(o,v,void 0,n||void 0)}),l.push.apply(l,C([],A(r.machine.config.predictableActionArguments?o.actions:o.actions.map(function(m){return Nn(m,o)})),!1)),c=c||!!o.changed};try{for(var a=R(e),f=a.next();!f.done;f=a.next()){var u=f.value;d(u)}}catch(h){i={error:h}}finally{try{f&&!f.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}o.changed=c,o.actions=l,r.update(o,G(e[e.length-1]))})}},t.prototype.sender=function(e){return this.send.bind(this,e)},t.prototype._nextState=function(e,r){var n=this;r===void 0&&(r=!!this.machine.config.predictableActionArguments&&this._exec);var i=G(e);if(i.name.indexOf(Wt)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(Wt)===0}))throw i.data.data;var s=ve(this,function(){return n.machine.transition(n.state,i,void 0,r||void 0)});return s},t.prototype.nextState=function(e){return this._nextState(e,!1)},t.prototype.forward=function(e){var r,n;try{for(var i=R(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,c=this.children.get(o);if(!c)throw new Error("Unable to forward event '".concat(e,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));c.send(e)}}catch(l){r={error:l}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},t.prototype.defer=function(e){var r=this;this.delayedEventsMap[e.id]=this.clock.setTimeout(function(){e.to?r.sendTo(e._event,e.to,!0):r.send(e._event)},e.delay)},t.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},t.prototype.exec=function(e,r,n){n===void 0&&(n=this.machine.options.actions),this._exec(e,r.context,r._event,n)},t.prototype.removeChild=function(e){var r;this.children.delete(e),this.forwardTo.delete(e),(r=this.state)===null||r===void 0||delete r.children[e]},t.prototype.stopChild=function(e){var r=this.children.get(e);r&&(this.removeChild(e),k(r.stop)&&r.stop())},t.prototype.spawn=function(e,r,n){if(this.status!==V.Running)return sr(e,r);if(Xt(e))return this.spawnPromise(Promise.resolve(e),r);if(k(e))return this.spawnCallback(e,r);if(Rn(e))return this.spawnActor(e,r);if(on(e))return this.spawnObservable(e,r);if(ae(e))return this.spawnMachine(e,p(p({},n),{id:r}));if(rn(e))return this.spawnBehavior(e,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof e,'".'))},t.prototype.spawnMachine=function(e,r){var n=this;r===void 0&&(r={});var i=new t(e,p(p({},this.options),{parent:this,id:r.id||e.id})),s=p(p({},Mn),r);s.sync&&i.onTransition(function(c){n.send(qt,{state:c,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(c){n.removeChild(i.id),n.send(G(c,{origin:i.id}))}).start(),o},t.prototype.spawnBehavior=function(e,r){var n=Dn(e,{id:r,parent:this});return this.children.set(r,n),n},t.prototype.spawnPromise=function(e,r){var n,i=this,s=!1,o;e.then(function(l){s||(o=l,i.removeChild(r),i.send(G(He(r,l),{origin:r})))},function(l){if(!s){i.removeChild(r);var d=Ie(r,l);try{i.send(G(d,{origin:r}))}catch(a){un(l,a,r),i.devTools&&i.devTools.send(d,i.state),i.machine.strict&&i.stop()}}});var c=(n={id:r,send:function(){},subscribe:function(l,d,a){var f=Ge(l,d,a),u=!1;return e.then(function(h){u||(f.next(h),!u&&f.complete())},function(h){u||f.error(h)}),{unsubscribe:function(){return u=!0}}},stop:function(){s=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return o}},n[ie]=function(){return this},n);return this.children.set(r,c),c},t.prototype.spawnCallback=function(e,r){var n,i=this,s=!1,o=new Set,c=new Set,l,d=function(u){l=u,c.forEach(function(h){return h(u)}),!s&&i.send(G(u,{origin:r}))},a;try{a=e(d,function(u){o.add(u)})}catch(u){this.send(Ie(r,u))}if(Xt(a))return this.spawnPromise(a,r);var f=(n={id:r,send:function(u){return o.forEach(function(h){return h(u)})},subscribe:function(u){var h=Ge(u);return c.add(h.next),{unsubscribe:function(){c.delete(h.next)}}},stop:function(){s=!0,k(a)&&a()},toJSON:function(){return{id:r}},getSnapshot:function(){return l}},n[ie]=function(){return this},n);return this.children.set(r,f),f},t.prototype.spawnObservable=function(e,r){var n,i=this,s,o=e.subscribe(function(l){s=l,i.send(G(l,{origin:r}))},function(l){i.removeChild(r),i.send(G(Ie(r,l),{origin:r}))},function(){i.removeChild(r),i.send(G(He(r),{origin:r}))}),c=(n={id:r,send:function(){},subscribe:function(l,d,a){return e.subscribe(l,d,a)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:r}}},n[ie]=function(){return this},n);return this.children.set(r,c),c},t.prototype.spawnActor=function(e,r){return this.children.set(r,e),e},t.prototype.spawnActivity=function(e){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(!r){j||K(!1,"No implementation found for activity '".concat(e.type,"'"));return}var n=r(this.state.context,e);this.spawnEffect(e.id,n)},t.prototype.spawnEffect=function(e,r){var n;this.children.set(e,(n={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:e}}},n[ie]=function(){return this},n))},t.prototype.attachDev=function(){var e=wt();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(p(p({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:p({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}Cn(this)}},t.prototype.toJSON=function(){return{id:this.id}},t.prototype[ie]=function(){return this},t.prototype.getSnapshot=function(){return this.status===V.NotStarted?this.initialState:this._state},t.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(e,r){return setTimeout(e,r)},clearTimeout:function(e){return clearTimeout(e)}},logger:console.log.bind(console),devTools:!1},t.interpret=pe,t}();function pe(t,e){var r=new Un(t,e);return r}function Ln(t){if(typeof t=="string"){var e={type:t};return e.toString=function(){return t},e}return t}function Be(t){return p(p({type:lt},t),{toJSON:function(){t.onDone,t.onError;var e=ot(t,["onDone","onError"]);return p(p({},e),{type:lt,src:Ln(t.src)})}})}var ye="",St="#",ke="*",me={},ge=function(t){return t[0]===St},jn=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},Vn=function(t,e,r){var n=r.slice(0,-1).some(function(s){return!("cond"in s)&&!("in"in s)&&(b(s.target)||ae(s.target))}),i=e===ye?"the transient event":"event '".concat(e,"'");K(!n,"One or more transitions for ".concat(i," on state '").concat(t.id,"' are unreachable. ")+"Make sure that the default transition is the last one defined.")},Kn=function(){function t(e,r,n,i){n===void 0&&(n="context"in e?e.context:void 0);var s=this,o;this.config=e,this._context=n,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(jn(),r),this.parent=i==null?void 0:i.parent,this.key=this.config.key||(i==null?void 0:i.key)||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:Yt),this.id=this.config.id||C([this.machine.key],A(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(o=this.config.schema)!==null&&o!==void 0?o:{},this.description=this.config.description,j||K(!("parallel"in this.config),'The "parallel" property is deprecated and will be removed in version 4.1. '.concat(this.config.parallel?"Replace with `type: 'parallel'`":"Use `type: '".concat(this.type,"'`")," in the config for state node '").concat(this.id,"' instead.")),this.initial=this.config.initial,this.states=this.config.states?_e(this.config.states,function(d,a){var f,u=new t(d,{},void 0,{parent:s,key:a});return Object.assign(s.idMap,p((f={},f[u.id]=u,f),u.idMap)),u}):me;var c=0;function l(d){var a,f;d.order=c++;try{for(var u=R(or(d)),h=u.next();!h.done;h=u.next()){var v=h.value;l(v)}}catch(m){a={error:m}}finally{try{h&&!h.done&&(f=u.return)&&f.call(u)}finally{if(a)throw a.error}}}l(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(d){var a=d.event;return a===ye}):ye in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=q(this.config.entry||this.config.onEntry).map(function(d){return be(d)}),this.onExit=q(this.config.exit||this.config.onExit).map(function(d){return be(d)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=q(this.config.invoke).map(function(d,a){var f,u;if(ae(d)){var h=Fe(s.id,a);return s.machine.options.services=p((f={},f[h]=d,f),s.machine.options.services),Be({src:h,id:h})}else if(b(d.src)){var h=d.id||Fe(s.id,a);return Be(p(p({},d),{id:h,src:d.src}))}else if(ae(d.src)||k(d.src)){var h=d.id||Fe(s.id,a);return s.machine.options.services=p((u={},u[h]=d.src,u),s.machine.options.services),Be(p(p({id:h},d),{src:h}))}else{var v=d.src;return Be(p(p({id:Fe(s.id,a)},d),{src:v}))}}),this.activities=q(this.config.activities).concat(this.invoke).map(function(d){return yt(d)}),this.transition=this.transition.bind(this),this.tags=q(this.config.tags)}return t.prototype._init=function(){this.__cache.transitions||ar(this).forEach(function(e){return e.on})},t.prototype.withConfig=function(e,r){var n=this.options,i=n.actions,s=n.activities,o=n.guards,c=n.services,l=n.delays;return new t(this.config,{actions:p(p({},i),e.actions),activities:p(p({},s),e.activities),guards:p(p({},o),e.guards),services:p(p({},c),e.services),delays:p(p({},l),e.delays)},r!=null?r:this.context)},t.prototype.withContext=function(e){return new t(this.config,this.options,e)},Object.defineProperty(t.prototype,"context",{get:function(){return k(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:_e(this.states,function(e){return e.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return this.definition},Object.defineProperty(t.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var e=this.transitions;return this.__cache.on=e.reduce(function(r,n){return r[n.eventType]=r[n.eventType]||[],r[n.eventType].push(n),r},{})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),t.prototype.getCandidates=function(e){if(this.__cache.candidates[e])return this.__cache.candidates[e];var r=e===ye,n=this.transitions.filter(function(i){var s=i.eventType===e;return r?s:s||i.eventType===ke});return this.__cache.candidates[e]=n,n},t.prototype.getDelayedTransitions=function(){var e=this,r=this.config.after;if(!r)return[];var n=function(s,o){var c=k(s)?"".concat(e.id,":delay[").concat(o,"]"):s,l=En(c,e.id);return e.onEntry.push(mt(l,{delay:s})),e.onExit.push(vn(l)),l},i=fe(r)?r.map(function(s,o){var c=n(s.delay,o);return p(p({},s),{event:c})}):U(Object.keys(r).map(function(s,o){var c=r[s],l=b(c)?{target:c}:c,d=isNaN(+s)?s:+s,a=n(d,o);return q(l).map(function(f){return p(p({},f),{event:a,delay:d})})}));return i.map(function(s){var o=s.delay;return p(p({},e.formatTransition(s)),{delay:o})})},t.prototype.getStateNodes=function(e){var r,n=this;if(!e)return[];var i=e instanceof J?e.value:Oe(e,this.delimiter);if(b(i)){var s=this.getStateNode(i).initial;return s!==void 0?this.getStateNodes((r={},r[i]=s,r)):[this,this.states[i]]}var o=Object.keys(i),c=[this];return c.push.apply(c,C([],A(U(o.map(function(l){return n.getStateNode(l).getStateNodes(i[l])}))),!1)),c},t.prototype.handles=function(e){var r=Bt(e);return this.events.includes(r)},t.prototype.resolveState=function(e){var r=e instanceof J?e:J.create(e),n=Array.from(xe([],this.getStateNodes(r.value)));return new J(p(p({},r),{value:this.resolve(r.value),configuration:n,done:Ye(n,this),tags:ur(n),machine:this.machine}))},t.prototype.transitionLeafNode=function(e,r,n){var i=this.getStateNode(e),s=i.next(r,n);return!s||!s.transitions.length?this.next(r,n):s},t.prototype.transitionCompoundNode=function(e,r,n){var i=Object.keys(e),s=this.getStateNode(i[0]),o=s._transition(e[i[0]],r,n);return!o||!o.transitions.length?this.next(r,n):o},t.prototype.transitionParallelNode=function(e,r,n){var i,s,o={};try{for(var c=R(Object.keys(e)),l=c.next();!l.done;l=c.next()){var d=l.value,a=e[d];if(a){var f=this.getStateNode(d),u=f._transition(a,r,n);u&&(o[d]=u)}}}catch(g){i={error:g}}finally{try{l&&!l.done&&(s=c.return)&&s.call(c)}finally{if(i)throw i.error}}var h=Object.keys(o).map(function(g){return o[g]}),v=U(h.map(function(g){return g.transitions})),m=h.some(function(g){return g.transitions.length>0});if(!m)return this.next(r,n);var E=U(h.map(function(g){return g.entrySet})),S=U(Object.keys(o).map(function(g){return o[g].configuration}));return{transitions:v,entrySet:E,exitSet:U(h.map(function(g){return g.exitSet})),configuration:S,source:r,actions:U(Object.keys(o).map(function(g){return o[g].actions}))}},t.prototype._transition=function(e,r,n){return b(e)?this.transitionLeafNode(e,r,n):Object.keys(e).length===1?this.transitionCompoundNode(e,r,n):this.transitionParallelNode(e,r,n)},t.prototype.getTransitionData=function(e,r){return this._transition(e.value,e,G(r))},t.prototype.next=function(e,r){var n,i,s=this,o=r.name,c=[],l=[],d;try{for(var a=R(this.getCandidates(o)),f=a.next();!f.done;f=a.next()){var u=f.value,h=u.cond,v=u.in,m=e.context,E=v?b(v)&&ge(v)?e.matches(Oe(this.getStateNodeById(v).path,this.delimiter)):dt(Oe(v,this.delimiter),Zr(this.path.slice(0,-2))(e.value)):!0,S=!1;try{S=!h||rr(this.machine,h,m,r,e)}catch(O){throw new Error("Unable to evaluate guard '".concat(h.name||h.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(O.message))}if(S&&E){u.target!==void 0&&(l=u.target),c.push.apply(c,C([],A(u.actions),!1)),d=u;break}}}catch(O){n={error:O}}finally{try{f&&!f.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}if(d){if(!l.length)return{transitions:[d],entrySet:[],exitSet:[],configuration:e.value?[this]:[],source:e,actions:c};var g=U(l.map(function(O){return s.getRelativeStateNodes(O,e.historyValue)})),w=!!d.internal,N=[];return w||l.forEach(function(O){N.push.apply(N,C([],A(s.getExternalReentryNodes(O)),!1))}),{transitions:[d],entrySet:N,exitSet:w?[]:[this],configuration:g,source:e,actions:c}}},t.prototype.getExternalReentryNodes=function(e){for(var r=[],n=A(e.order>this.order?[e,this]:[this,e],2),i=n[0],s=n[1];i&&i!==s;)r.push(i),i=i.parent;return i!==s?[]:(r.push(s),r)},t.prototype.getActions=function(e,r,n,i,s,o,c){var l,d,a,f,u=this,h=xe([],o?this.getStateNodes(o.value):[this]);try{for(var v=R(e),m=v.next();!m.done;m=v.next()){var E=m.value;(!Pe(h,E)||Pe(n.entrySet,E.parent))&&n.entrySet.push(E)}}catch(T){l={error:T}}finally{try{m&&!m.done&&(d=v.return)&&d.call(v)}finally{if(l)throw l.error}}try{for(var S=R(h),g=S.next();!g.done;g=S.next()){var E=g.value;(!Pe(e,E)||Pe(n.exitSet,E.parent))&&n.exitSet.push(E)}}catch(T){a={error:T}}finally{try{g&&!g.done&&(f=S.return)&&f.call(S)}finally{if(a)throw a.error}}var w=U(n.entrySet.map(function(T){var D=[];if(T.type!=="final")return D;var W=T.parent;if(!W.parent)return D;D.push($e(T.id,T.doneData),$e(W.id,T.doneData?Ke(T.doneData,i,s):void 0));var z=W.parent;return z.type==="parallel"&&Ne(z).every(function(re){return Ye(n.configuration,re)})&&D.push($e(z.id)),D}));n.exitSet.sort(function(T,D){return D.order-T.order}),n.entrySet.sort(function(T,D){return T.order-D.order});var N=new Set(n.entrySet),O=new Set(n.exitSet),M=Array.from(N).map(function(T){var D=T.onEntry,W=T.activities.map(function(z){return pn(z)});return se(c?C(C([],A(D),!1),A(W),!1):C(C([],A(W),!1),A(D),!1),u.machine.options.actions)}).concat([w.map(ln)]),_=Array.from(O).map(function(T){return se(C(C([],A(T.onExit),!1),A(T.activities.map(function(D){return yn(D)})),!1),u.machine.options.actions)}),I=_.concat([se(n.actions,this.machine.options.actions)]).concat(M);if(r){var x=se(U(C([],A(e),!1).sort(function(T,D){return D.order-T.order}).map(function(T){return T.onExit})),this.machine.options.actions).filter(function(T){return T.type!==ue&&(T.type!==le||!!T.to&&T.to!==ne.Internal)});return I.concat([x])}return I},t.prototype.transition=function(e,r,n,i){e===void 0&&(e=this.initialState);var s=G(r),o;if(e instanceof J)o=n===void 0?e:this.resolveState(J.from(e,n));else{var c=b(e)?this.resolve(je(this.getResolvedPath(e))):this.resolve(e),l=n!=null?n:this.machine.context;o=this.resolveState(J.from(c,l))}if(!j&&s.name===ke)throw new Error("An event cannot have the wildcard type ('".concat(ke,"')"));if(this.strict&&!this.events.includes(s.name)&&!tn(s.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(s.name,"'"));var d=this._transition(o.value,o,s)||{transitions:[],configuration:[],entrySet:[],exitSet:[],source:o,actions:[]},a=xe([],this.getStateNodes(o.value)),f=d.configuration.length?xe(a,d.configuration):a;return d.configuration=C([],A(f),!1),this.resolveTransition(d,o,o.context,i,s)},t.prototype.resolveRaisedTransition=function(e,r,n,i){var s,o=e.actions;return e=this.transition(e,r,void 0,i),e._event=n,e.event=n.data,(s=e.actions).unshift.apply(s,C([],A(o),!1)),e},t.prototype.resolveTransition=function(e,r,n,i,s){var o,c,l,d,a=this;s===void 0&&(s=he);var f=e.configuration,u=!r||e.transitions.length>0,h=u?e.configuration:r?r.configuration:[],v=Ye(h,this),m=u?On(this.machine,f):void 0,E=r?r.historyValue?r.historyValue:e.source?this.machine.historyValue(r.value):void 0:void 0,S=this.getActions(new Set(h),v,e,n,s,r,i),g=r?p({},r.activities):{};try{for(var w=R(S),N=w.next();!N.done;N=w.next()){var O=N.value;try{for(var M=(l=void 0,R(O)),_=M.next();!_.done;_=M.next()){var I=_.value;I.type===at?g[I.activity.id||I.activity.type]=I:I.type===ct&&(g[I.activity.id||I.activity.type]=!1)}}catch(H){l={error:H}}finally{try{_&&!_.done&&(d=M.return)&&d.call(M)}finally{if(l)throw l.error}}}}catch(H){o={error:H}}finally{try{N&&!N.done&&(c=w.return)&&c.call(w)}finally{if(o)throw o.error}}var x=A(We(this,r,n,s,S,i,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),T=x[0],D=x[1],W=A(nn(T,function(H){return H.type===ue||H.type===le&&H.to===ne.Internal}),2),z=W[0],re=W[1],we=T.filter(function(H){var Te;return H.type===at&&((Te=H.activity)===null||Te===void 0?void 0:Te.type)===lt}),si=we.reduce(function(H,Te){return H[Te.activity.id]=Sn(Te.activity,a.machine,D,s),H},r?p({},r.children):{}),nt=new J({value:m||r.value,context:D,_event:s,_sessionid:r?r._sessionid:null,historyValue:m?E?sn(E,m):void 0:r?r.historyValue:void 0,history:!m||e.source?r:void 0,actions:m?re:[],activities:m?g:r?r.activities:{},events:[],configuration:h,transitions:e.transitions,children:si,done:v,tags:ur(h),machine:this}),Gr=n!==D;nt.changed=s.name===qt||Gr;var Se=nt.history;Se&&delete Se.history;var Fr=!v&&(this._transient||f.some(function(H){return H._transient}));if(!u&&(!Fr||s.name===ye))return nt;var B=nt;if(!v)for(Fr&&(B=this.resolveRaisedTransition(B,{type:qr},s,i));z.length;){var oi=z.shift();B=this.resolveRaisedTransition(B,oi._event,s,i)}var ai=B.changed||(Se?!!B.actions.length||Gr||typeof Se.value!=typeof B.value||!lr(B.value,Se.value):void 0);return B.changed=ai,B.history=Se,B},t.prototype.getStateNode=function(e){if(ge(e))return this.machine.getStateNodeById(e);if(!this.states)throw new Error("Unable to retrieve child state '".concat(e,"' from '").concat(this.id,"'; no child states exist."));var r=this.states[e];if(!r)throw new Error("Child state '".concat(e,"' does not exist on '").concat(this.id,"'"));return r},t.prototype.getStateNodeById=function(e){var r=ge(e)?e.slice(St.length):e;if(r===this.id)return this;var n=this.machine.idMap[r];if(!n)throw new Error("Child state node '#".concat(r,"' does not exist on machine '").concat(this.id,"'"));return n},t.prototype.getStateNodeByPath=function(e){if(typeof e=="string"&&ge(e))try{return this.getStateNodeById(e.slice(1))}catch{}for(var r=ht(e,this.delimiter).slice(),n=this;r.length;){var i=r.shift();if(!i.length)break;n=n.getStateNode(i)}return n},t.prototype.resolve=function(e){var r,n=this;if(!e)return this.initialStateValue||me;switch(this.type){case"parallel":return _e(this.initialStateValue,function(s,o){return s?n.getStateNode(o).resolve(e[o]||s):me});case"compound":if(b(e)){var i=this.getStateNode(e);return i.type==="parallel"||i.type==="compound"?(r={},r[e]=i.initialStateValue,r):e}return Object.keys(e).length?_e(e,function(s,o){return s?n.getStateNode(o).resolve(s):me}):this.initialStateValue||{};default:return e||me}},t.prototype.getResolvedPath=function(e){if(ge(e)){var r=this.machine.idMap[e.slice(St.length)];if(!r)throw new Error("Unable to find state node '".concat(e,"'"));return r.path}return ht(e,this.delimiter)},Object.defineProperty(t.prototype,"initialStateValue",{get:function(){var e;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var r;if(this.type==="parallel")r=Qt(this.states,function(n){return n.initialStateValue||me},function(n){return n.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));r=qe(this.states[this.initial])?this.initial:(e={},e[this.initial]=this.states[this.initial].initialStateValue,e)}else r={};return this.__cache.initialStateValue=r,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),t.prototype.getInitialState=function(e,r){this._init();var n=this.getStateNodes(e);return this.resolveTransition({configuration:n,entrySet:C([],A(n),!1),exitSet:[],transitions:[],source:void 0,actions:[]},void 0,r!=null?r:this.machine.context,void 0)},Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this.initialStateValue;if(!e)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){var e;if(this.type==="history"){var r=this.config;b(r.target)?e=ge(r.target)?je(this.machine.getStateNodeById(r.target).path.slice(this.path.length-1)):r.target:e=r.target}return e},enumerable:!1,configurable:!0}),t.prototype.getRelativeStateNodes=function(e,r,n){return n===void 0&&(n=!0),n?e.type==="history"?e.resolveHistory(r):e.initialStateNodes:[e]},Object.defineProperty(t.prototype,"initialStateNodes",{get:function(){var e=this;if(qe(this))return[this];if(this.type==="compound"&&!this.initial)return j||K(!1,"Compound state node '".concat(this.id,"' has no initial state.")),[this];var r=Ve(this.initialStateValue);return U(r.map(function(n){return e.getFromRelativePath(n)}))},enumerable:!1,configurable:!0}),t.prototype.getFromRelativePath=function(e){if(!e.length)return[this];var r=A(e),n=r[0],i=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(n,"' from node with no states"));var s=this.getStateNode(n);if(s.type==="history")return s.resolveHistory();if(!this.states[n])throw new Error("Child state '".concat(n,"' does not exist on '").concat(this.id,"'"));return this.states[n].getFromRelativePath(i)},t.prototype.historyValue=function(e){if(Object.keys(this.states).length)return{current:e||this.initialStateValue,states:Qt(this.states,function(r,n){if(!e)return r.historyValue();var i=b(e)?void 0:e[n];return r.historyValue(i||r.initialStateValue)},function(r){return!r.history})}},t.prototype.resolveHistory=function(e){var r=this;if(this.type!=="history")return[this];var n=this.parent;if(!e){var i=this.target;return i?U(Ve(i).map(function(o){return n.getFromRelativePath(o)})):n.initialStateNodes}var s=en(n.path,"states")(e).current;return b(s)?[n.getStateNode(s)]:U(Ve(s).map(function(o){return r.history==="deep"?n.getFromRelativePath(o):[n.states[o[0]]]}))},Object.defineProperty(t.prototype,"stateIds",{get:function(){var e=this,r=U(Object.keys(this.states).map(function(n){return e.states[n].stateIds}));return[this.id].concat(r)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){var e,r,n,i;if(this.__cache.events)return this.__cache.events;var s=this.states,o=new Set(this.ownEvents);if(s)try{for(var c=R(Object.keys(s)),l=c.next();!l.done;l=c.next()){var d=l.value,a=s[d];if(a.states)try{for(var f=(n=void 0,R(a.events)),u=f.next();!u.done;u=f.next()){var h=u.value;o.add("".concat(h))}}catch(v){n={error:v}}finally{try{u&&!u.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}}}catch(v){e={error:v}}finally{try{l&&!l.done&&(r=c.return)&&r.call(c)}finally{if(e)throw e.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ownEvents",{get:function(){var e=new Set(this.transitions.filter(function(r){return!(!r.target&&!r.actions.length&&r.internal)}).map(function(r){return r.eventType}));return Array.from(e)},enumerable:!1,configurable:!0}),t.prototype.resolveTarget=function(e){var r=this;if(e!==void 0)return e.map(function(n){if(!b(n))return n;var i=n[0]===r.delimiter;if(i&&!r.parent)return r.getStateNodeByPath(n.slice(1));var s=i?r.key+n:n;if(r.parent)try{var o=r.parent.getStateNodeByPath(s);return o}catch(c){throw new Error("Invalid transition definition for state node '".concat(r.id,`':
`).concat(c.message))}else return r.getStateNodeByPath(s)})},t.prototype.formatTransition=function(e){var r=this,n=cn(e.target),i="internal"in e?e.internal:n?n.some(function(l){return b(l)&&l[0]===r.delimiter}):!0,s=this.machine.options.guards,o=this.resolveTarget(n),c=p(p({},e),{actions:se(q(e.actions)),cond:tr(e.cond,s),target:o,source:this,internal:i,eventType:e.event,toJSON:function(){return p(p({},c),{target:c.target?c.target.map(function(l){return"#".concat(l.id)}):void 0,source:"#".concat(r.id)})}});return c},t.prototype.formatTransitions=function(){var e,r,n=this,i;if(!this.config.on)i=[];else if(Array.isArray(this.config.on))i=this.config.on;else{var s=this.config.on,o=ke,c=s[o],l=c===void 0?[]:c,d=ot(s,[typeof o=="symbol"?o:o+""]);i=U(Object.keys(d).map(function(g){!j&&g===ye&&K(!1,"Empty string transition configs (e.g., `{ on: { '': ... }}`) for transient transitions are deprecated. Specify the transition in the `{ always: ... }` property instead. "+'Please check the `on` configuration for "#'.concat(n.id,'".'));var w=de(g,d[g]);return j||Vn(n,g,w),w}).concat(de(ke,l)))}var a=this.config.always?de("",this.config.always):[],f=this.config.onDone?de(String($e(this.id)),this.config.onDone):[];j||K(!(this.config.onDone&&!this.parent),'Root nodes cannot have an ".onDone" transition. Please check the config of "'.concat(this.id,'".'));var u=U(this.invoke.map(function(g){var w=[];return g.onDone&&w.push.apply(w,C([],A(de(String(He(g.id)),g.onDone)),!1)),g.onError&&w.push.apply(w,C([],A(de(String(Ie(g.id)),g.onError)),!1)),w})),h=this.after,v=U(C(C(C(C([],A(f),!1),A(u),!1),A(i),!1),A(a),!1).map(function(g){return q(g).map(function(w){return n.formatTransition(w)})}));try{for(var m=R(h),E=m.next();!E.done;E=m.next()){var S=E.value;v.push(S)}}catch(g){e={error:g}}finally{try{E&&!E.done&&(r=m.return)&&r.call(m)}finally{if(e)throw e.error}}return v},t}(),dr=!1;function Ee(t,e){return!j&&!t.predictableActionArguments&&!dr&&(dr=!0,console.warn("It is highly recommended to set `predictableActionArguments` to `true` when using `createMachine`. https://xstate.js.org/docs/guides/actions.html")),new Kn(t,e)}var L=gn,$=mt;const Qe={user:null,mfa:null,accessToken:{value:null,expiresAt:null},refreshTimer:{startedAt:null,attempts:0,lastAttempt:null},refreshToken:{value:null},importTokenAttempts:0,errors:{}};function Gn(t){return new TextEncoder().encode(t)}function ce(t){const e=new Uint8Array(t);let r="";for(const i of e)r+=String.fromCharCode(i);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Tt(t){const e=t.replace(/-/g,"+").replace(/_/g,"/"),r=(4-e.length%4)%4,n=e.padEnd(e.length+r,"="),i=atob(n),s=new ArrayBuffer(i.length),o=new Uint8Array(s);for(let c=0;c<i.length;c++)o[c]=i.charCodeAt(c);return s}function hr(){return(window==null?void 0:window.PublicKeyCredential)!==void 0&&typeof window.PublicKeyCredential=="function"}function vr(t){const{id:e}=t;return{...t,id:Tt(e),transports:t.transports}}function pr(t){return t==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}class F extends Error{constructor(e,r="WebAuthnError"){super(e),this.name=r}}function Fn({error:t,options:e}){var r,n;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal===new AbortController().signal)return new F("Registration ceremony was sent an abort signal","AbortError")}else if(t.name==="ConstraintError"){if(((r=i.authenticatorSelection)===null||r===void 0?void 0:r.requireResidentKey)===!0)return new F("Discoverable credentials were required but no available authenticator supported it","ConstraintError");if(((n=i.authenticatorSelection)===null||n===void 0?void 0:n.userVerification)==="required")return new F("User verification was required but no available authenticator supported it","ConstraintError")}else{if(t.name==="InvalidStateError")return new F("The authenticator was previously registered","InvalidStateError");if(t.name==="NotAllowedError")return new F("User clicked cancel, or the registration ceremony timed out","NotAllowedError");if(t.name==="NotSupportedError")return i.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new F('No entry in pubKeyCredParams was of type "public-key"',"NotSupportedError"):new F("No available authenticator supported any of the specified pubKeyCredParams algorithms","NotSupportedError");if(t.name==="SecurityError"){const s=window.location.hostname;if(pr(s)){if(i.rp.id!==s)return new F(`The RP ID "${i.rp.id}" is invalid for this domain`,"SecurityError")}else return new F(`${window.location.hostname} is an invalid domain`,"SecurityError")}else if(t.name==="TypeError"){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new F("User ID was not between 1 and 64 characters","TypeError")}else if(t.name==="UnknownError")return new F("The authenticator was unable to process the specified options, or could not create a new credential","UnknownError")}return t}class $n{createNewAbortSignal(){return this.controller&&this.controller.abort(),this.controller=new AbortController,this.controller.signal}reset(){this.controller=void 0}}const Je=new $n;async function yr(t){if(!hr())throw new Error("WebAuthn is not supported in this browser");const r={publicKey:{...t,challenge:Tt(t.challenge),user:{...t.user,id:Gn(t.user.id)},excludeCredentials:t.excludeCredentials.map(vr)}};r.signal=Je.createNewAbortSignal();let n;try{n=await navigator.credentials.create(r)}catch(d){throw Fn({error:d,options:r})}finally{Je.reset()}if(!n)throw new Error("Registration was not completed");const{id:i,rawId:s,response:o,type:c}=n,l={id:i,rawId:ce(s),response:{attestationObject:ce(o.attestationObject),clientDataJSON:ce(o.clientDataJSON)},type:c,clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:n.authenticatorAttachment};return typeof o.getTransports=="function"&&(l.transports=o.getTransports()),l}function Hn(t){return new TextDecoder("utf-8").decode(t)}async function Wn(){if(navigator.credentials.conditionalMediationSupported)return!0;const t=window.PublicKeyCredential;return t.isConditionalMediationAvailable!==void 0&&t.isConditionalMediationAvailable()}function qn({error:t,options:e}){var r;const{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal===new AbortController().signal)return new F("Authentication ceremony was sent an abort signal","AbortError")}else{if(t.name==="NotAllowedError")return!((r=n.allowCredentials)===null||r===void 0)&&r.length?new F("No available authenticator recognized any of the allowed credentials","NotAllowedError"):new F("User clicked cancel, or the authentication ceremony timed out","NotAllowedError");if(t.name==="SecurityError"){const i=window.location.hostname;if(pr(i)){if(n.rpId!==i)return new F(`The RP ID "${n.rpId}" is invalid for this domain`,"SecurityError")}else return new F(`${window.location.hostname} is an invalid domain`,"SecurityError")}else if(t.name==="UnknownError")return new F("The authenticator was unable to process the specified options, or could not create a new assertion signature","UnknownError")}return t}async function Yn(t,e=!1){var r,n;if(!hr())throw new Error("WebAuthn is not supported in this browser");let i;((r=t.allowCredentials)===null||r===void 0?void 0:r.length)!==0&&(i=(n=t.allowCredentials)===null||n===void 0?void 0:n.map(vr));const s={...t,challenge:Tt(t.challenge),allowCredentials:i},o={};if(e){if(!await Wn())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete*='webauthn']").length<1)throw Error('No <input> with `"webauthn"` in its `autocomplete` attribute was detected');o.mediation="conditional",s.allowCredentials=[]}o.publicKey=s,o.signal=Je.createNewAbortSignal();let c;try{c=await navigator.credentials.get(o)}catch(h){throw qn({error:h,options:o})}finally{Je.reset()}if(!c)throw new Error("Authentication was not completed");const{id:l,rawId:d,response:a,type:f}=c;let u;return a.userHandle&&(u=Hn(a.userHandle)),{id:l,rawId:ce(d),response:{authenticatorData:ce(a.authenticatorData),clientDataJSON:ce(a.clientDataJSON),signature:ce(a.signature),userHandle:u},type:f,clientExtensionResults:c.getClientExtensionResults(),authenticatorAttachment:c.authenticatorAttachment}}/*! js-cookie v3.0.1 | MIT */function Xe(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)t[n]=r[n]}return t}var zn={read:function(t){return t[0]==='"'&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function Rt(t,e){function r(i,s,o){if(typeof document!="undefined"){o=Xe({},e,o),typeof o.expires=="number"&&(o.expires=new Date(Date.now()+o.expires*864e5)),o.expires&&(o.expires=o.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var c="";for(var l in o)o[l]&&(c+="; "+l,o[l]!==!0&&(c+="="+o[l].split(";")[0]));return document.cookie=i+"="+t.write(s,i)+c}}function n(i){if(!(typeof document=="undefined"||arguments.length&&!i)){for(var s=document.cookie?document.cookie.split("; "):[],o={},c=0;c<s.length;c++){var l=s[c].split("="),d=l.slice(1).join("=");try{var a=decodeURIComponent(l[0]);if(o[a]=t.read(d,a),i===a)break}catch{}}return i?o[i]:o}}return Object.create({set:r,get:n,remove:function(i,s){r(i,"",Xe({},s,{expires:-1}))},withAttributes:function(i){return Rt(this.converter,Xe({},this.attributes,i))},withConverter:function(i){return Rt(Xe({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(t)}})}var At=Rt(zn,{path:"/"});const Ze=typeof window!="undefined",et=new Map,Bn=t=>{var e;return Ze&&typeof localStorage!="undefined"?localStorage.getItem(t):(e=et.get(t))!=null?e:null},Qn=(t,e)=>{Ze&&typeof localStorage!="undefined"?e?localStorage.setItem(t,e):localStorage.removeItem(t):e?et.set(t,e):et.has(t)&&et.delete(t)},mr=(t,e)=>{if(t==="localStorage"||t==="web")return Bn;if(t==="cookie")return r=>{var n;return Ze&&(n=At.get(r))!=null?n:null};if(!e)throw Error(`clientStorageType is set to '${t}' but no clientStorage has been given`);if(t==="react-native")return r=>{var n;return(n=e.getItem)==null?void 0:n.call(e,r)};if(t==="capacitor")return r=>{var n;return(n=e.get)==null?void 0:n.call(e,{key:r})};if(t==="expo-secure-storage")return r=>{var n;return(n=e.getItemAsync)==null?void 0:n.call(e,r)};if(t==="custom"){if(e.getItem&&e.removeItem)return e.getItem;if(e.getItemAsync)return e.getItemAsync;throw Error(`clientStorageType is set to 'custom' but clientStorage is missing either "getItem" and "removeItem" properties or "getItemAsync" property`)}throw Error(`Unknown storage type: ${t}`)},gr=(t,e)=>{if(t==="localStorage"||t==="web")return Qn;if(t==="cookie")return(r,n)=>{Ze&&(n?At.set(r,n,{expires:30,sameSite:"lax",httpOnly:!1}):At.remove(r))};if(!e)throw Error(`clientStorageType is set to '${t}' but no clienStorage has been given`);if(t==="react-native")return(r,n)=>{var i,s;return n?(i=e.setItem)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};if(t==="capacitor")return(r,n)=>{var i,s;return n?(i=e.set)==null?void 0:i.call(e,{key:r,value:n}):(s=e.remove)==null?void 0:s.call(e,{key:r})};if(t==="expo-secure-storage")return async(r,n)=>{var i,s;return n?(i=e.setItemAsync)==null?void 0:i.call(e,r,n):(s=e.deleteItemAsync)==null?void 0:s.call(e,r)};if(t==="custom"){if(!e.removeItem)throw Error("clientStorageType is set to 'custom' but clientStorage is missing a removeItem property");if(e.setItem)return(r,n)=>{var i,s;return n?(i=e.setItem)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};if(e.setItemAsync)return async(r,n)=>{var i,s;return n?(i=e.setItemAsync)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};throw Error("clientStorageType is set to 'custom' but clientStorage is missing setItem or setItemAsync property")}throw Error(`Unknown storage type: ${t}`)},Ce=t=>!t||!t.accessToken.value||!t.refreshToken.value||!t.accessToken.expiresAt||!t.user?null:{accessToken:t.accessToken.value,accessTokenExpiresIn:(t.accessToken.expiresAt.getTime()-Date.now())/1e3,refreshToken:t.refreshToken.value,user:t.user},oe=({accessToken:t,isError:e,user:r,error:n})=>e?{session:null,error:n}:r&&t?{session:{accessToken:t,accessTokenExpiresIn:0,refreshToken:"",user:r},error:null}:{session:null,error:null},tt=()=>typeof window!="undefined";function Jn(t){var e=t.default;if(typeof e=="function"){var r=function n(){if(this instanceof n){var i=[null];i.push.apply(i,arguments);var s=Function.bind.apply(e,i);return new s}return e.apply(this,arguments)};r.prototype=e.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(t).forEach(function(n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(r,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}),r}function Xn(t,e){return e=e||{},new Promise(function(r,n){var i=new XMLHttpRequest,s=[],o=[],c={},l=function(){return{ok:(i.status/100|0)==2,statusText:i.statusText,status:i.status,url:i.responseURL,text:function(){return Promise.resolve(i.responseText)},json:function(){return Promise.resolve(i.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([i.response]))},clone:l,headers:{keys:function(){return s},entries:function(){return o},get:function(a){return c[a.toLowerCase()]},has:function(a){return a.toLowerCase()in c}}}};for(var d in i.open(e.method||"get",t,!0),i.onload=function(){i.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(a,f,u){s.push(f=f.toLowerCase()),o.push([f,u]),c[f]=c[f]?c[f]+","+u:u}),r(l())},i.onerror=n,i.withCredentials=e.credentials=="include",e.headers)i.setRequestHeader(d,e.headers[d]);i.send(e.body||null)})}const Er=Jn(Object.freeze(Object.defineProperty({__proto__:null,default:Xn},Symbol.toStringTag,{value:"Module"})));var Zn=self.fetch||(self.fetch=Er.default||Er);const wr=async(t,e,{token:r,body:n}={})=>{const i={"Content-Type":"application/json",Accept:"*/*"};r&&(i.Authorization=`Bearer ${r}`);const s={method:e,headers:i};n&&(s.body=JSON.stringify(n));try{const o=await Zn(t,s);if(!o.ok){const c=await o.json();return Promise.reject({error:c})}try{return{data:await o.json(),error:null}}catch{return console.warn(`Unexpected response: can't parse the response of the server at ${t}`),{data:"OK",error:null}}}catch{const c={message:"Network Error",status:0,error:"network"};return Promise.reject({error:c})}},ee=async(t,e,r)=>wr(t,"POST",{token:r,body:e}),Sr=(t,e)=>wr(t,"GET",{token:e}),Ot=(t,e)=>{const r=e&&Object.entries(e).map(([n,i])=>{const s=Array.isArray(i)?i.join(","):typeof i=="object"?JSON.stringify(i):i;return`${n}=${encodeURIComponent(s)}`}).join("&");return r?`${t}?${r}`:t},Y=(t,e)=>{if(!(e!=null&&e.redirectTo))return e;const{redirectTo:r,...n}=e;if(!t)return r.startsWith("/")?n:e;const i=new URL(t),s=Object.fromEntries(new URLSearchParams(i.search)),o=new URL(r.startsWith("/")?i.origin+r:r),c=new URLSearchParams(o.search);let l=Object.fromEntries(c);r.startsWith("/")&&(l={...s,...l});let d=i.pathname;return o.pathname.length>1&&(d+=o.pathname.slice(1)),{...n,redirectTo:Ot(o.origin+d,l)}};function De(t,e){var i;if(!e){if(typeof window=="undefined")return;e=((i=window.location)==null?void 0:i.href)||""}t=t.replace(/[\[\]]/g,"\\$&");const r=new RegExp("[?&#]"+t+"(=([^&#]*)|&|#|$)"),n=r.exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function _t(t){var r;if(typeof window=="undefined")return;const e=window==null?void 0:window.location;if(e&&e){const n=new URLSearchParams(e.search),i=new URLSearchParams((r=e.hash)==null?void 0:r.slice(1));n.delete(t),i.delete(t);let s=window.location.pathname;Array.from(n).length&&(s+=`?${n.toString()}`),Array.from(i).length&&(s+=`#${i.toString()}`),window.history.pushState({},"",s)}}const te=t=>!!t&&typeof t=="string"&&!!String(t).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),rt=t=>!!t&&typeof t=="string"&&t.length>=3,bt=t=>!!t&&typeof t=="string",Tr=t=>t&&typeof t=="string"&&t.match(/^mfaTotp:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i),Rr=({backendUrl:t,clientUrl:e,clientStorageType:r="web",clientStorage:n,refreshIntervalTime:i,autoRefreshToken:s=!0,autoSignIn:o=!0})=>{const c=mr(r,n),l=gr(r,n),d=async(a,f,u)=>(await ee(`${t}${a}`,f,u)).data;return Ee({schema:{context:{},events:{},services:{}},tsTypes:{},context:Qe,predictableActionArguments:!0,id:"nhost",type:"parallel",states:{authentication:{initial:"starting",on:{SESSION_UPDATE:[{cond:"hasSession",actions:["saveSession","resetTimer","reportTokenChanged"],target:".signedIn"}]},states:{starting:{tags:["loading"],always:{cond:"isSignedIn",target:"signedIn"},invoke:{id:"importRefreshToken",src:"importRefreshToken",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"signedIn"},{target:"signedOut"}],onError:[{cond:"shouldRetryImportToken",actions:"incrementTokenImportAttempts",target:"retryTokenImport"},{actions:["saveAuthenticationError"],target:"signedOut"}]}},retryTokenImport:{tags:["loading"],after:{RETRY_IMPORT_TOKEN_DELAY:"starting"}},signedOut:{initial:"noErrors",entry:"reportSignedOut",states:{noErrors:{},success:{},needsSmsOtp:{},needsMfa:{},failed:{},signingOut:{entry:["clearContextExceptRefreshToken"],exit:["destroyRefreshToken","reportTokenChanged"],invoke:{src:"signout",id:"signingOut",onDone:{target:"success"},onError:{target:"failed",actions:["saveAuthenticationError"]}}}},on:{SIGNIN_PASSWORD:"authenticating.password",SIGNIN_ANONYMOUS:"authenticating.anonymous",SIGNIN_SECURITY_KEY_EMAIL:"authenticating.securityKeyEmail",SIGNIN_MFA_TOTP:"authenticating.mfa.totp"}},authenticating:{entry:"resetErrors",states:{password:{invoke:{src:"signInPassword",id:"authenticateUserWithPassword",onDone:[{cond:"hasMfaTicket",actions:["saveMfaTicket"],target:"#nhost.authentication.signedOut.needsMfa"},{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"}],onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}},anonymous:{invoke:{src:"signInAnonymous",id:"authenticateAnonymously",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}}},mfa:{states:{totp:{invoke:{src:"signInMfaTotp",id:"signInMfaTotp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:["saveAuthenticationError"],target:"#nhost.authentication.signedOut.failed"}}}}},securityKeyEmail:{invoke:{src:"signInSecurityKeyEmail",id:"authenticateUserWithSecurityKey",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}}}},signedIn:{type:"parallel",entry:["reportSignedIn","cleanUrl","broadcastToken","resetErrors"],on:{SIGNOUT:"signedOut.signingOut"},states:{refreshTimer:{id:"timer",initial:"idle",states:{disabled:{type:"final"},stopped:{always:{cond:"noToken",target:"idle"}},idle:{always:[{cond:"isAutoRefreshDisabled",target:"disabled"},{cond:"hasRefreshToken",target:"running"}]},running:{initial:"pending",entry:"resetTimer",states:{pending:{after:{1e3:{internal:!1,target:"pending"}},always:{cond:"refreshTimerShouldRefresh",target:"refreshing"}},refreshing:{invoke:{src:"refreshToken",id:"refreshToken",onDone:{actions:["saveSession","resetTimer","reportTokenChanged"],target:"pending"},onError:[{actions:"saveRefreshAttempt",target:"pending"}]}}}}}}}}}},token:{initial:"idle",states:{idle:{on:{TRY_TOKEN:"running"},initial:"noErrors",states:{noErrors:{},error:{}}},running:{invoke:{src:"refreshToken",id:"authenticateWithToken",onDone:{actions:["saveSession","reportTokenChanged"],target:["#nhost.authentication.signedIn","idle.noErrors"]},onError:[{cond:"isSignedIn",target:"idle.error"},{actions:"saveAuthenticationError",target:["#nhost.authentication.signedOut.failed","idle.error"]}]}}}},registration:{initial:"incomplete",on:{SIGNED_IN:[{cond:"isAnonymous",target:".incomplete"},".complete"]},states:{incomplete:{on:{SIGNUP_EMAIL_PASSWORD:"emailPassword",SIGNUP_SECURITY_KEY:"securityKey",PASSWORDLESS_EMAIL:"passwordlessEmail",PASSWORDLESS_SMS:"passwordlessSms",PASSWORDLESS_SMS_OTP:"passwordlessSmsOtp"},initial:"noErrors",states:{noErrors:{},needsEmailVerification:{},needsOtp:{},failed:{}}},emailPassword:{entry:["resetErrors"],invoke:{src:"signUpEmailPassword",id:"signUpEmailPassword",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]}],onError:[{cond:"unverified",target:"incomplete.needsEmailVerification"},{actions:"saveRegistrationError",target:"incomplete.failed"}]}},securityKey:{entry:["resetErrors"],invoke:{src:"signUpSecurityKey",id:"signUpSecurityKey",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]}],onError:[{cond:"unverified",target:"incomplete.needsEmailVerification"},{actions:"saveRegistrationError",target:"incomplete.failed"}]}},passwordlessEmail:{entry:["resetErrors"],invoke:{src:"passwordlessEmail",id:"passwordlessEmail",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSms:{entry:["resetErrors"],invoke:{src:"passwordlessSms",id:"passwordlessSms",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsOtp"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSmsOtp:{entry:["resetErrors"],invoke:{src:"passwordlessSmsOtp",id:"passwordlessSmsOtp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},complete:{on:{SIGNED_OUT:"incomplete"}}}}}},{actions:{reportSignedIn:$("SIGNED_IN"),reportSignedOut:$("SIGNED_OUT"),reportTokenChanged:$("TOKEN_CHANGED"),incrementTokenImportAttempts:L({importTokenAttempts:({importTokenAttempts:a})=>a+1}),clearContext:L(()=>(l(Re,null),l(X,null),{...Qe})),clearContextExceptRefreshToken:L(({refreshToken:{value:a}})=>(l(Re,null),{...Qe,refreshToken:{value:a}})),saveSession:L({user:(a,{data:f})=>{var u;return((u=f==null?void 0:f.session)==null?void 0:u.user)||null},accessToken:(a,{data:f})=>{if(f.session){const{accessTokenExpiresIn:u,accessToken:h}=f.session,v=new Date(Date.now()+u*1e3);return l(Re,v.toISOString()),{value:h,expiresAt:v}}return l(Re,null),{value:null,expiresAt:null}},refreshToken:(a,{data:f})=>{var h;const u=((h=f.session)==null?void 0:h.refreshToken)||null;return u&&l(X,u),{value:u}}}),saveMfaTicket:L({mfa:(a,f)=>{var u;return(u=f.data)==null?void 0:u.mfa}}),resetTimer:L({refreshTimer:a=>({startedAt:new Date,attempts:0,lastAttempt:null})}),saveRefreshAttempt:L({refreshTimer:(a,f)=>({startedAt:a.refreshTimer.startedAt,attempts:a.refreshTimer.attempts+1,lastAttempt:new Date})}),saveAuthenticationError:L({errors:({errors:a},{data:{error:f}})=>({...a,authentication:f})}),resetErrors:L({errors:a=>({}),importTokenAttempts:a=>0}),saveRegistrationError:L({errors:({errors:a},{data:{error:f}})=>({...a,registration:f})}),destroyRefreshToken:L({refreshToken:a=>(l(X,null),{value:null})}),cleanUrl:()=>{o&&De("refreshToken")&&(_t("refreshToken"),_t("type"))},broadcastToken:a=>{if(o)try{new BroadcastChannel("nhost").postMessage(a.refreshToken.value)}catch{}}},guards:{isAnonymous:(a,f)=>{var u;return!!((u=a.user)!=null&&u.isAnonymous)},isSignedIn:a=>!!a.user&&!!a.refreshToken.value&&!!a.accessToken.value,noToken:a=>!a.refreshToken.value,hasRefreshToken:a=>!!a.refreshToken.value,isAutoRefreshDisabled:()=>!s,refreshTimerShouldRefresh:a=>{const{expiresAt:f}=a.accessToken;return f?a.refreshTimer.lastAttempt?a.refreshTimer.attempts>5?!1:Date.now()-a.refreshTimer.lastAttempt.getTime()>Math.pow(2,a.refreshTimer.attempts-1)*5e3:i&&Date.now()-a.refreshTimer.startedAt.getTime()>i*1e3?!0:f.getTime()-Date.now()-1e3*300<=0:!1},shouldRetryImportToken:(a,f)=>a.importTokenAttempts<5&&(f.data.error.status===0||f.data.error.status>=500),unverified:(a,{data:{error:f}})=>f.status===401&&(f.message==="Email is not verified"||f.error==="unverified-user"),hasSession:(a,f)=>{var u;return!!((u=f.data)!=null&&u.session)},hasMfaTicket:(a,f)=>{var u;return!!((u=f.data)!=null&&u.mfa)}},services:{signInPassword:(a,{email:f,password:u})=>te(f)?rt(u)?d("/signin/email-password",{email:f,password:u}):Promise.reject({error:Me}):Promise.reject({error:Z}),passwordlessSms:(a,{phoneNumber:f,options:u})=>{var h;return bt(f)?(h=a.user)!=null&&h.isAnonymous?(console.warn("Deanonymisation from a phone number is not yet implemented in hasura-auth"),d("/user/deanonymize",{signInMethod:"passwordless",connection:"sms",phoneNumber:f,options:Y(e,u)},a.accessToken.value)):d("/signin/passwordless/sms",{phoneNumber:f,options:Y(e,u)}):Promise.reject({error:it})},passwordlessSmsOtp:(a,{phoneNumber:f,otp:u})=>bt(f)?d("/signin/passwordless/sms/otp",{phoneNumber:f,otp:u}):Promise.reject({error:it}),passwordlessEmail:(a,{email:f,options:u})=>{var h;return te(f)?(h=a.user)!=null&&h.isAnonymous?d("/user/deanonymize",{signInMethod:"passwordless",connection:"email",email:f,options:Y(e,u)},a.accessToken.value):d("/signin/passwordless/email",{email:f,options:Y(e,u)}):Promise.reject({error:Z})},signInAnonymous:a=>d("/signin/anonymous"),signInMfaTotp:(a,f)=>{var h;const u=f.ticket||((h=a.mfa)==null?void 0:h.ticket);return u?Tr(u)?d("/signin/mfa/totp",{ticket:u,otp:f.otp}):Promise.reject({error:Dt}):Promise.reject({error:Mt})},signInSecurityKeyEmail:async(a,{email:f})=>{if(!te(f))throw new Ae(Z);const u=await d("/signin/webauthn",{email:f});let h;try{h=await Yn(u)}catch(v){throw new Ae(v)}return d("/signin/webauthn/verify",{email:f,credential:h})},refreshToken:async(a,f)=>{const u=f.type==="TRY_TOKEN"?f.token:a.refreshToken.value;return{session:await d("/token",{refreshToken:u}),error:null}},signout:(a,f)=>d("/signout",{refreshToken:a.refreshToken.value,all:!!f.all}),signUpEmailPassword:async(a,{email:f,password:u,options:h})=>{var v;return te(f)?rt(u)?(v=a.user)!=null&&v.isAnonymous?d("/user/deanonymize",{signInMethod:"email-password",email:f,password:u,options:Y(e,h)},a.accessToken.value):d("/signup/email-password",{email:f,password:u,options:Y(e,h)}):Promise.reject({error:Me}):Promise.reject({error:Z})},signUpSecurityKey:async(a,{email:f,options:u})=>{if(!te(f))return Promise.reject({error:Z});const h=u==null?void 0:u.nickname;h&&delete u.nickname;const v=await d("/signup/webauthn",{email:f,options:u});let m;try{m=await yr(v)}catch(E){throw new Ae(E)}return d("/signup/webauthn/verify",{credential:m,options:{redirectTo:u==null?void 0:u.redirectTo,nickname:h}})},importRefreshToken:async a=>{if(a.user&&a.refreshToken.value&&a.accessToken.value&&a.accessToken.expiresAt)return{session:{accessToken:a.accessToken.value,accessTokenExpiresIn:a.accessToken.expiresAt.getTime()-Date.now(),refreshToken:a.refreshToken.value,user:a.user},error:null};let f=null;if(o){const h=De("refreshToken")||null;if(h)try{return{session:await d("/token",{refreshToken:h}),error:null}}catch(v){f=v.error}else{const v=De("error");if(v)return Promise.reject({session:null,error:{status:10,error:v,message:De("errorDescription")||v}})}}const u=await c(X);if(u)try{return{session:await d("/token",{refreshToken:u}),error:null}}catch(h){f=h.error}return f?Promise.reject({error:f,session:null}):{error:null,session:null}}},delays:{RETRY_IMPORT_TOKEN_DELAY:({importTokenAttempts:a})=>Math.pow(2,a-1)*5e3}})},Ar=({backendUrl:t,clientUrl:e,interpreter:r})=>Ee({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changeEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:L({error:n=>Z}),saveRequestError:L({error:(n,{data:{error:i}})=>i}),reportError:$(n=>({type:"ERROR",error:n.error})),reportSuccess:$("SUCCESS")},guards:{invalidEmail:(n,{email:i})=>!te(i)},services:{requestChange:async(n,{email:i,options:s})=>(await ee(`${t}/user/email/change`,{newEmail:i,options:Y(e,s)},r==null?void 0:r.getSnapshot().context.accessToken.value)).data}}),Or=({backendUrl:t,interpreter:e})=>Ee({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidPassword",actions:"saveInvalidPasswordError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidPasswordError:L({error:r=>Me}),saveRequestError:L({error:(r,{data:{error:n}})=>n}),reportError:$(r=>({type:"ERROR",error:r.error})),reportSuccess:$("SUCCESS")},guards:{invalidPassword:(r,{password:n})=>!rt(n)},services:{requestChange:(r,{password:n,ticket:i})=>ee(`${t}/user/password`,{newPassword:n,ticket:i},e==null?void 0:e.getSnapshot().context.accessToken.value)}}),ei=({backendUrl:t,interpreter:e})=>Ee({schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,id:"enableMfa",initial:"idle",context:{error:null,imageUrl:null,secret:null},states:{idle:{initial:"initial",on:{GENERATE:"generating"},states:{initial:{},error:{}}},generating:{invoke:{src:"generate",id:"generate",onDone:{target:"generated",actions:["reportGeneratedSuccess","saveGeneration"]},onError:{actions:["saveError","reportGeneratedError"],target:"idle.error"}}},generated:{initial:"idle",states:{idle:{initial:"idle",on:{ACTIVATE:[{cond:"invalidMfaType",actions:"saveInvalidMfaTypeError",target:".error"},{cond:"invalidMfaCode",actions:"saveInvalidMfaCodeError",target:".error"},{target:"activating"}]},states:{idle:{},error:{}}},activating:{invoke:{src:"activate",id:"activate",onDone:{target:"activated",actions:"reportSuccess"},onError:{actions:["saveError","reportError"],target:"idle.error"}}},activated:{type:"final"}}}}},{actions:{saveInvalidMfaTypeError:L({error:r=>kt}),saveInvalidMfaCodeError:L({error:r=>Ct}),saveError:L({error:(r,{data:{error:n}})=>n}),saveGeneration:L({imageUrl:(r,{data:{imageUrl:n}})=>n,secret:(r,{data:{totpSecret:n}})=>n}),reportError:$((r,n)=>(console.log("REPORT",r,n),{type:"ERROR",error:r.error})),reportSuccess:$("SUCCESS"),reportGeneratedSuccess:$("GENERATED"),reportGeneratedError:$(r=>({type:"GENERATED_ERROR",error:r.error}))},guards:{invalidMfaCode:(r,{code:n})=>!n,invalidMfaType:(r,{activeMfaType:n})=>!n||n!=="totp"},services:{generate:async r=>{const{data:n}=await Sr(`${t}/mfa/totp/generate`,e==null?void 0:e.getSnapshot().context.accessToken.value);return n},activate:(r,{code:n,activeMfaType:i})=>ee(`${t}/user/mfa`,{code:n,activeMfaType:i},e==null?void 0:e.getSnapshot().context.accessToken.value)}}),_r=({backendUrl:t,clientUrl:e})=>Ee({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:L({error:r=>Z}),saveRequestError:L({error:(r,{data:{error:n}})=>n}),reportError:$(r=>({type:"ERROR",error:r.error})),reportSuccess:$("SUCCESS")},guards:{invalidEmail:(r,{email:n})=>!te(n)},services:{requestChange:(r,{email:n,options:i})=>ee(`${t}/user/password/reset`,{email:n,options:Y(e,i)})}}),br=({backendUrl:t,clientUrl:e})=>Ee({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"sendVerificationEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"request",id:"request",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:L({error:r=>Z}),saveRequestError:L({error:(r,{data:{error:n}})=>n}),reportError:$(r=>({type:"ERROR",error:r.error})),reportSuccess:$("SUCCESS")},guards:{invalidEmail:(r,{email:n})=>!te(n)},services:{request:async(r,{email:n,options:i})=>(await ee(`${t}/user/email/send-verification-email`,{email:n,options:Y(e,i)})).data}});class It{constructor({clientStorageType:e="web",autoSignIn:r=!0,autoRefreshToken:n=!0,start:i=!0,backendUrl:s,clientUrl:o,devTools:c,...l}){if(this._started=!1,this._subscriptionsQueue=new Set,this._subscriptions=new Set,this.backendUrl=s,this.clientUrl=o,this._machine=Rr({...l,backendUrl:s,clientUrl:o,clientStorageType:e,autoSignIn:r,autoRefreshToken:n}),i&&this.start({devTools:c}),typeof window!="undefined"&&r)try{this._channel=new BroadcastChannel("nhost"),this._channel.addEventListener("message",d=>{var f;const a=(f=this.interpreter)==null?void 0:f.getSnapshot().context.refreshToken.value;this.interpreter&&d.data!==a&&this.interpreter.send("TRY_TOKEN",{token:d.data})})}catch{}}start({devTools:e=!1,initialSession:r,interpreter:n}={}){var o,c;const i={...this.machine.context};r&&(i.user=r.user,i.refreshToken.value=(o=r.refreshToken)!=null?o:null,i.accessToken.value=(c=r.accessToken)!=null?c:null,i.accessToken.expiresAt=new Date(Date.now()+r.accessTokenExpiresIn*1e3));const s=this.machine.withContext(i);this._interpreter||(this._interpreter=n||pe(s,{devTools:e})),(!this._started||typeof window=="undefined")&&(this._interpreter.initialized&&(this._interpreter.stop(),this._subscriptions.forEach(l=>l())),this._interpreter.start(s.initialState),this._subscriptionsQueue.forEach(l=>l(this))),this._started=!0}get machine(){return this._machine}get interpreter(){return this._interpreter}get started(){return this._started}subscribe(e){if(this.started){const r=e(this);return this._subscriptions.add(r),r}else return this._subscriptionsQueue.add(e),()=>{console.log("onTokenChanged was added before the interpreter started. Cannot unsubscribe listener.")}}}class Ir extends It{constructor({...e}){super({...e,autoSignIn:tt()&&e.autoSignIn,autoRefreshToken:tt()&&e.autoRefreshToken,clientStorageType:"cookie"})}}const ti=Ir,Nr=async({backendUrl:t,interpreter:e},r)=>{try{const{data:n}=await ee(`${t}/user/webauthn/add`,{},e==null?void 0:e.getSnapshot().context.accessToken.value);let i;try{i=await yr(n)}catch(o){throw new Ae(o)}const{data:s}=await ee(`${t}/user/webauthn/verify`,{credential:i,nickname:r},e==null?void 0:e.getSnapshot().context.accessToken.value);return{key:s,isError:!1,error:null,isSuccess:!0}}catch(n){const{error:i}=n;return{isError:!0,error:i,isSuccess:!1}}},xr=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,needsEmailVerification:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,needsEmailVerification:!0})})}),Pr=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{password:e,ticket:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSuccess:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSuccess:!0})})}),ri=t=>new Promise(e=>{t.send("GENERATE"),t.onTransition(r=>{r.matches("generated")?e({error:null,isError:!1,isGenerated:!0,qrCodeDataUrl:r.context.imageUrl||""}):r.matches({idle:"error"})&&e({error:r.context.error||null,isError:!0,isGenerated:!1,qrCodeDataUrl:""})})}),ni=(t,e)=>new Promise(r=>{t.send("ACTIVATE",{activeMfaType:"totp",code:e}),t.onTransition(n=>{n.matches({generated:"activated"})?r({error:null,isActivated:!0,isError:!1}):n.matches({generated:{idle:"error"}})&&r({error:n.context.error,isActivated:!1,isError:!0})})}),kr=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSent:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSent:!0})})}),Cr=(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSent:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSent:!0})})}),Dr=t=>new Promise(e=>{const{changed:r}=t.send("SIGNIN_ANONYMOUS");r||e({isSuccess:!1,isError:!0,error:Q,user:null,accessToken:null}),t.onTransition(n=>{n.matches({authentication:"signedIn"})&&e({isSuccess:!0,isError:!1,error:null,user:n.context.user,accessToken:n.context.accessToken.value}),n.matches({authentication:{signedOut:"failed"}})&&e({isSuccess:!1,isError:!0,error:n.context.errors.authentication||null,user:null,accessToken:null})})}),Mr=(t,e,r)=>new Promise(n=>{const{changed:i,context:s}=t.send("SIGNIN_PASSWORD",{email:e,password:r});if(!i)return n({accessToken:s.accessToken.value,error:Q,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:s.user});t.onTransition(o=>{o.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?n({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,needsMfaOtp:!1,mfa:null,user:null}):o.matches({authentication:{signedOut:"needsMfa"}})?n({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!0,mfa:o.context.mfa,user:null}):o.matches({authentication:{signedOut:"failed"}})?n({accessToken:null,error:o.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:null}):o.matches({authentication:"signedIn"})&&n({accessToken:o.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:o.context.user})})}),Nt=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send("PASSWORDLESS_EMAIL",{email:e,options:r});if(!i)return n({error:Q,isError:!0,isSuccess:!1});t.onTransition(s=>{s.matches("registration.incomplete.failed")?n({error:s.context.errors.registration||null,isError:!0,isSuccess:!1}):s.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})&&n({error:null,isError:!1,isSuccess:!0})})}),Ur=(t,e)=>new Promise(r=>{const{changed:n,context:i}=t.send({type:"SIGNIN_SECURITY_KEY_EMAIL",email:e});if(!n)return r({accessToken:i.accessToken.value,error:Q,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:i.user});t.onTransition(s=>{s.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?r({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):s.matches({authentication:{signedOut:"failed"}})?r({accessToken:null,error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):s.matches({authentication:"signedIn"})&&r({accessToken:s.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:s.context.user})})}),Lr=(t,e,r)=>new Promise(n=>{const{changed:i,context:s}=t.send("SIGNIN_MFA_TOTP",{otp:e,ticket:r});if(!i)return n({accessToken:s.accessToken.value,error:Q,isError:!0,isSuccess:!1,user:s.user});t.onTransition(o=>{o.matches({authentication:{signedOut:"failed"}})?n({accessToken:null,error:o.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null}):o.matches({authentication:"signedIn"})&&n({accessToken:o.context.accessToken.value,error:null,isError:!1,isSuccess:!0,user:o.context.user})})}),xt=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send("PASSWORDLESS_SMS",{phoneNumber:e,options:r});if(!i)return n({error:Q,isError:!0,isSuccess:!1,needsOtp:!1});t.onTransition(s=>{s.matches("registration.incomplete.needsOtp")?n({error:null,isError:!1,isSuccess:!1,needsOtp:!0}):s.matches("registration.incomplete.failed")&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,needsOtp:!1})})}),jr=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send({type:"PASSWORDLESS_SMS_OTP",phoneNumber:e,otp:r});if(!i)return n({error:Q,isError:!0,isSuccess:!1,user:null,accessToken:null});t.onTransition(s=>{s.matches({authentication:"signedIn"})?n({error:null,isError:!1,isSuccess:!0,user:s.context.user,accessToken:s.context.accessToken.value}):s.matches({registration:{incomplete:"failed"}})&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null,accessToken:null})})}),Vr=async(t,e)=>new Promise(r=>{const{event:n}=t.send("SIGNOUT",{all:e});if(n.type!=="SIGNED_OUT")return r({isSuccess:!1,isError:!0,error:jt});t.onTransition(i=>{i.matches({authentication:{signedOut:"success"}})?r({isSuccess:!0,isError:!1,error:null}):i.matches("authentication.signedOut.failed")&&r({isSuccess:!1,isError:!0,error:i.context.errors.signout||null})})}),Pt=(t,e,r,n)=>new Promise(i=>{const{changed:s,context:o}=t.send("SIGNUP_EMAIL_PASSWORD",{email:e,password:r,options:n});if(!s)return i({error:Q,accessToken:o.accessToken.value,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:o.user});t.onTransition(c=>{c.matches("registration.incomplete.failed")?i({accessToken:null,error:c.context.errors.registration||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):c.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?i({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):c.matches({authentication:"signedIn",registration:"complete"})&&i({accessToken:c.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:c.context.user})})}),Kr=(t,e,r)=>new Promise(n=>{const{changed:i,context:s}=t.send("SIGNUP_SECURITY_KEY",{email:e,options:r});if(!i)return n({error:Q,accessToken:s.accessToken.value,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:s.user});t.onTransition(o=>{o.matches("registration.incomplete.failed")?n({accessToken:null,error:o.context.errors.registration||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):o.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?n({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):o.matches({authentication:"signedIn",registration:"complete"})&&n({accessToken:o.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:o.context.user})})});class ii{constructor({url:e,autoRefreshToken:r=!0,autoSignIn:n=!0,clientStorage:i,clientStorageType:s,refreshIntervalTime:o,start:c=!0}){var l;this.url=e,this._client=new It({backendUrl:e,clientUrl:typeof window!="undefined"&&((l=window.location)==null?void 0:l.origin)||"",autoRefreshToken:r,autoSignIn:n,start:c,clientStorage:i,clientStorageType:s,refreshIntervalTime:o})}async signUp(e){const r=await this.waitUntilReady(),{email:n,options:i}=e;return"securityKey"in e?oe(await Kr(r,n,i)):oe(await Pt(r,n,e.password,i))}async signIn(e){const r=await this.waitUntilReady();if(!e){const n=await Dr(r);return{...oe(n),mfa:null}}if("provider"in e){const{provider:n,options:i}=e,s=Ot(`${this._client.backendUrl}/signin/provider/${n}`,Y(this._client.clientUrl,i));return tt()&&(window.location.href=s),{providerUrl:s,provider:n,session:null,mfa:null,error:null}}if("email"in e&&"password"in e){const n=await Mr(r,e.email,e.password);return n.needsEmailVerification?{session:null,mfa:null,error:Vt}:n.needsMfaOtp?{session:null,mfa:n.mfa,error:null}:{...oe(n),mfa:null}}if("email"in e&&"securityKey"in e){if(e.securityKey!==!0)throw Error("securityKey must be true");const n=await Ur(r,e.email);return{...oe(n),mfa:null}}if("email"in e){const{email:n,options:i}=e,{error:s}=await Nt(r,n,i);return{session:null,mfa:null,error:s}}if("phoneNumber"in e&&"otp"in e){const n=await jr(r,e.phoneNumber,e.otp);return{...oe(n),mfa:null}}if("phoneNumber"in e){const{error:n}=await xt(r,e.phoneNumber,e.options);return{error:n,mfa:null,session:null}}if("otp"in e){const n=await Lr(r,e.otp,e.ticket);return{...oe(n),mfa:null}}return{error:Gt,mfa:null,session:null}}async signOut(e){const r=await this.waitUntilReady(),{error:n}=await Vr(r,e==null?void 0:e.all);return{error:n}}async resetPassword({email:e,options:r}){const n=pe(_r(this._client)).start(),{error:i}=await kr(n,e,r);return{error:i}}async changePassword({newPassword:e,ticket:r}){const n=pe(Or(this._client)).start(),{error:i}=await Pr(n,e,r);return{error:i}}async sendVerificationEmail({email:e,options:r}){const n=pe(br(this._client)).start(),{error:i}=await Cr(n,e,r);return{error:i}}async changeEmail({newEmail:e,options:r}){const n=pe(Ar(this._client)).start(),{error:i}=await xr(n,e,r);return{error:i}}async deanonymize(e){const r=await this.waitUntilReady();if(e.signInMethod==="passwordless"){if(e.connection==="email"){const{error:n}=await Nt(r,e.email,e.options);return{error:n}}if(e.connection==="sms"){const{error:n}=await xt(r,e.phoneNumber,e.options);return{error:n}}}if(e.signInMethod==="email-password"){const{error:n}=await Pt(r,e.email,e.password,e.options);return{error:n}}throw Error("Unknown deanonymization method")}async addSecurityKey(e){const{error:r,key:n}=await Nr(this._client,e);return{error:r,key:n}}onTokenChanged(e){return this._client.subscribe(()=>{var n;const r=(n=this._client.interpreter)==null?void 0:n.onTransition(({event:i,context:s})=>{i.type==="TOKEN_CHANGED"&&e(Ce(s))});return()=>r==null?void 0:r.stop()})}onAuthStateChanged(e){return this._client.subscribe(()=>{var n;const r=(n=this._client.interpreter)==null?void 0:n.onTransition(({event:i,context:s})=>{(i.type==="SIGNED_IN"||i.type==="SIGNED_OUT")&&e(i.type,Ce(s))});return()=>r==null?void 0:r.stop()})}isAuthenticated(){var e;return!!((e=this._client.interpreter)!=null&&e.getSnapshot().matches({authentication:"signedIn"}))}async isAuthenticatedAsync(){return(await this.waitUntilReady()).getSnapshot().matches({authentication:"signedIn"})}getAuthenticationStatus(){var r;const e=((r=this.client.interpreter)==null?void 0:r.getSnapshot().context.importTokenAttempts)||0;return this.isReady()?{isAuthenticated:this.isAuthenticated(),isLoading:!1,connectionAttempts:e}:{isAuthenticated:!1,isLoading:!0,connectionAttempts:e}}getAccessToken(){var e,r;return(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot().context.accessToken.value)!=null?r:void 0}getDecodedAccessToken(){const e=this.getAccessToken();return e?Wr(e):null}getHasuraClaims(){var e;return((e=this.getDecodedAccessToken())==null?void 0:e["https://hasura.io/jwt/claims"])||null}getHasuraClaim(e){var r;return((r=this.getHasuraClaims())==null?void 0:r[e.startsWith("x-hasura-")?e:`x-hasura-${e}`])||null}async refreshSession(e){try{const r=await this.waitUntilReady();return new Promise(n=>{const i=e||r.getSnapshot().context.refreshToken.value;if(!i)return n({session:null,error:Ut});const{changed:s}=r.send("TRY_TOKEN",{token:i});if(!s)return n({session:null,error:Lt});r.onTransition(o=>{o.matches({token:{idle:"error"}})?n({session:null,error:Kt}):o.event.type==="TOKEN_CHANGED"&&n({session:Ce(o.context),error:null})})})}catch(r){return{session:null,error:r.message}}}getSession(){var e,r;return Ce((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)}getUser(){var e,r,n;return((n=(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)==null?void 0:n.user)||null}waitUntilReady(){const r=this._client.interpreter;if(!r)throw Error("Auth interpreter not set");return r.getSnapshot().hasTag("loading")?new Promise((n,i)=>{let s=setTimeout(()=>i(`The state machine is not yet ready after ${15} seconds.`),15e3);r.onTransition(o=>{if(!o.hasTag("loading"))return clearTimeout(s),n(r)})}):Promise.resolve(r)}isReady(){var e,r;return!((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())!=null&&r.hasTag("loading"))}get client(){return this._client}}y.AuthClient=It,y.AuthClientSSR=ti,y.AuthCookieClient=Ir,y.CodifiedError=Ae,y.EMAIL_NEEDS_VERIFICATION=Vt,y.HasuraAuthClient=ii,y.INITIAL_MACHINE_CONTEXT=Qe,y.INVALID_EMAIL_ERROR=Z,y.INVALID_MFA_CODE_ERROR=Ct,y.INVALID_MFA_TICKET_ERROR=Dt,y.INVALID_MFA_TYPE_ERROR=kt,y.INVALID_PASSWORD_ERROR=Me,y.INVALID_PHONE_NUMBER_ERROR=it,y.INVALID_REFRESH_TOKEN=Kt,y.INVALID_SIGN_IN_METHOD=Gt,y.MIN_PASSWORD_LENGTH=3,y.NETWORK_ERROR_CODE=0,y.NHOST_JWT_EXPIRES_AT_KEY=Re,y.NHOST_REFRESH_TOKEN_KEY=X,y.NO_MFA_TICKET_ERROR=Mt,y.NO_REFRESH_TOKEN=Ut,y.OTHER_ERROR_CODE=1,y.REFRESH_TOKEN_MAX_ATTEMPTS=5,y.STATE_ERROR_CODE=20,y.TOKEN_REFRESHER_RUNNING_ERROR=Lt,y.TOKEN_REFRESH_MARGIN=300,y.USER_ALREADY_SIGNED_IN=Q,y.USER_NOT_ANONYMOUS=$r,y.USER_UNAUTHENTICATED=jt,y.VALIDATION_ERROR_CODE=10,y.activateMfaPromise=ni,y.addSecurityKeyPromise=Nr,y.changeEmailPromise=xr,y.changePasswordPromise=Pr,y.createAuthMachine=Rr,y.createChangeEmailMachine=Ar,y.createChangePasswordMachine=Or,y.createEnableMfaMachine=ei,y.createResetPasswordMachine=_r,y.createSendVerificationEmailMachine=br,y.encodeQueryParameters=Ot,y.generateQrCodePromise=ri,y.getAuthenticationResult=oe,y.getFetch=Sr,y.getParameterByName=De,y.getSession=Ce,y.isBrowser=tt,y.isValidEmail=te,y.isValidPassword=rt,y.isValidPhoneNumber=bt,y.isValidTicket=Tr,y.localStorageGetter=mr,y.localStorageSetter=gr,y.postFetch=ee,y.removeParameterFromWindow=_t,y.resetPasswordPromise=kr,y.rewriteRedirectTo=Y,y.sendVerificationEmailPromise=Cr,y.signInAnonymousPromise=Dr,y.signInEmailPasswordPromise=Mr,y.signInEmailPasswordlessPromise=Nt,y.signInEmailSecurityKeyPromise=Ur,y.signInMfaTotpPromise=Lr,y.signInSmsPasswordlessOtpPromise=jr,y.signInSmsPasswordlessPromise=xt,y.signOutPromise=Vr,y.signUpEmailPasswordPromise=Pt,y.signUpEmailSecurityKeyPromise=Kr,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=hasura-auth-js.umd.js.map
